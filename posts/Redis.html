<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Redis | byxl8112</title><meta name="keywords" content="Java笔记"><meta name="author" content="byxl8112"><meta name="copyright" content="byxl8112"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Redis学习">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="https://byxl8112.github.io/posts/Redis.html">
<meta property="og:site_name" content="byxl8112">
<meta property="og:description" content="Redis学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/12-Redis.webp">
<meta property="article:published_time" content="2023-07-07T04:06:47.000Z">
<meta property="article:modified_time" content="2023-07-25T00:42:12.568Z">
<meta property="article:author" content="byxl8112">
<meta property="article:tag" content="Java笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/12-Redis.webp"><link rel="shortcut icon" href="https://typora8112.oss-cn-beijing.aliyuncs.com/zzzw_8112/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20221130105527.jpg"><link rel="canonical" href="https://byxl8112.github.io/posts/Redis"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"一年之内的产物","messageNext":"技术可能存在过期"},
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-25 08:42:12'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link defer rel="stylesheet" href="/css/customm.css" ><link defer rel="stylesheet" href="https://npm.elemecdn.com/xianqi-hexo/css/icon.css"><link defer rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"><link defer rel="stylesheet" href="https://npm.elemecdn.com/xianqi-hexo/css/background.css"><link defer rel="stylesheet" href="https://npm.elemecdn.com/xianqi-hexo/css/index_ee.css"><link defer rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/zzzw_8112/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20221130105527.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fas fa-book"></i><span> 说说</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/List/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/List/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/12-Redis.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">byxl8112</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-folder-open"></i><span> 归档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fas fa-book"></i><span> 说说</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/List/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/List/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-07T04:06:47.000Z" title="发表于 2023-07-07 12:06:47">2023-07-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-07-25T00:42:12.568Z" title="更新于 2023-07-25 08:42:12">2023-07-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/Redis/">Redis</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><strong>NoSQL适用场景</strong></p>
<ul>
<li>对数据高并发的读写</li>
<li>海量数据的读写</li>
<li>对数据高可扩展性的</li>
</ul>
<p><strong>NoSQL不适用场景</strong></p>
<ul>
<li>需要事务支持</li>
<li>基于sql的结构化查询存储，处理复杂的关系,需要即席查询。</li>
<li>（用不着sql的和用了sql也不行的情况，请考虑用NoSql）</li>
</ul>
<p><strong>Mwmcache</strong></p>
<ul>
<li>很早出现的NoSql数据库</li>
<li>数据都在内存中，一般不持久化</li>
<li>支持简单的key-value模式，支持类型单一</li>
<li>一般是作为缓存数据库辅助持久化的数据库</li>
</ul>
<p><strong>Redis</strong></p>
<ul>
<li>几乎覆盖了Memcached的绝大部分功能</li>
<li>数据都在内存中，支持持久化，主要用作备份恢复</li>
<li>除了支持简单的key-value模式，还支持多种数据结构的存储，比如 list、set、hash、zset等。</li>
<li>一般是作为缓存数据库辅助持久化的数据库</li>
</ul>
<p><strong>MongoDB</strong></p>
<ul>
<li>高性能、开源、模式自由(schema  free)的<strong>文档型数据库</strong></li>
<li>数据都在内存中， 如果内存不足，把不常用的数据保存到硬盘</li>
<li>虽然是key-value模式，但是对value（尤其是<strong>json</strong>）提供了丰富的查询功能</li>
<li>支持二进制数据及大型对象</li>
<li>可以根据数据的特点替代<strong>RDBMS</strong> ，成为独立的数据库。或者配合RDBMS，存储特定的数据。</li>
</ul>
<h1 id="Redis概述和安装"><a href="#Redis概述和安装" class="headerlink" title="Redis概述和安装"></a>Redis概述和安装</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ul>
<li>Redis是一个开源的 key-value 存储系统。</li>
<li>和Memcached类似，它支持存储的value类型相对更多，包括string(字符串)、list(链表)、set(集合)、zset(sorted set –有序集合和hash（哈希类型）。</li>
<li>这些数据类型都支持push&#x2F;pop、add&#x2F;remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。</li>
<li>在此基础上，Redis支持各种不同方式的排序。</li>
<li>与memcached一样，为了保证效率，数据都是缓存在内存中。</li>
<li>区别的是Redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件。</li>
<li>并且在此基础上实现了master-slave(主从)同步。</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ul>
<li>Redis官网：<a target="_blank" rel="noopener" href="http://redis.io/"><strong>http://redis.io</strong></a></li>
</ul>
<ul>
<li>Redis中文官网：<a target="_blank" rel="noopener" href="http://redis.cn/"><strong>http://redis.cn</strong></a></li>
</ul>
<p><strong>安装版本：</strong> <code>redis-7.0.12.tar.gz</code>  （Linux环境下安装） </p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li><p><strong>下载最新版的gcc编译器</strong></p>
<p><code>yum install centos-release-scl scl-utils-build</code> </p>
<p><code>yum install -y devtoolset-8-toolchain</code> </p>
<p><code>scl enable devtoolset-8 bash</code> </p>
</li>
<li><p><strong>测试</strong></p>
<p><code>gcc -version</code> </p>
</li>
<li><p>下载 <strong>redis-7.0.12.tar.gz</strong> 后放 &#x2F;opt 目录</p>
<pre class="line-numbers language-none"><code class="language-none">cd 当前目录
mv redis-7.0.12.tar.gz &#x2F;opt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>解压 redis-7.0.12.tar.gz </p>
<pre class="line-numbers language-none"><code class="language-none">tar -zwvf redis-7.0.12.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>解压完成后进入目录</p>
<pre class="line-numbers language-none"><code class="language-none">cd redis-7.0.12<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>在 redis-7.0.12 目录下再次执行 make 命令（只是编译好）</p>
</li>
<li><p>如果没有准备好 C 语言编译环境，make 会报错 <code>Jemalloc/jemalloc.h</code> 表示没有这个文件</p>
<p><font color='red'><strong>解决：</strong></font>运行 <code>make distclean</code> </p>
</li>
<li><p>在redis-6.2.1目录下再次执行make命令（只是编译好）</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718095249546.png" alt="image-20230718095249546" style="zoom:67%;" /> 
</li>
<li><p>跳过 make test 继续执行：<code>make install</code> </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718095342582.png" alt="image-20230718095342582" style="zoom:67%;" /></li>
</ol>
<h3 id="安装目录"><a href="#安装目录" class="headerlink" title="安装目录"></a>安装目录</h3><p>默认安装到：<code>/usr/local/bin</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718100021517.png" alt="image-20230718100021517"></p>
<ul>
<li><code>redis-benchmark</code>：性能测试工具，可以在自己本子运行，看看自己本子性能如何</li>
<li><code>redis-check-aof</code>：修复有问题的AOF文件，rdb和aof后面讲</li>
<li><code>redis-check-dump</code>：修复有问题的dump.rdb文件</li>
<li><code>redis-sentinel</code>：Redis集群使用</li>
<li><code>redis-server</code>：Redis服务器启动命令</li>
<li><code>redis-cli</code>：客户端，操作入口</li>
</ul>
<h3 id="前台启动（不推荐）"><a href="#前台启动（不推荐）" class="headerlink" title="前台启动（不推荐）"></a>前台启动（不推荐）</h3><p>前台启动，命令行窗口不能关闭，否则服务器停止</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718100851716.png" alt="image-20230718100851716"></p>
<h3 id="后台启动（推荐）"><a href="#后台启动（推荐）" class="headerlink" title="后台启动（推荐）"></a>后台启动（推荐）</h3><ol>
<li><p>备份 <strong>redis.conf</strong></p>
<p>拷贝一份 redis.conf 到其他目录</p>
<pre class="line-numbers language-none"><code class="language-none">cd &#x2F;opt&#x2F;redis-7.0.12
cp redis.conf &#x2F;myredis&#x2F;redis7.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ol>
<li><p>后台启动设置 <code>daemonize no</code> 改成 <code>daemonize yes</code> </p>
<p>修改 redis.conf (128行) 文件将里面的 <code>daemonize no</code> 改成 <code>darmonize yes</code> ，让服务在后台启动</p>
<ol>
<li>默认<code>protected-mode yes</code> 改为 <code>protected-mode no</code> </li>
<li>默认<code>bind 127.0.0.1</code> 改为 直接 注释掉（默认bind 127.0.0.1只能本机访问）或改成本机地址IP地址，否则影响远程IP连接</li>
<li>添加 redis 密码：改为 requirepass 自己设置密码（先要打开注释）</li>
</ol>
</li>
</ol>
</li>
<li><p>Redis启动</p>
<p><code>redis-server /myredis/redis.conf</code> </p>
<p><code>redis-cli -a 密码</code> 进入redis页面</p>
</li>
<li><p>用客户端访问：<code>redis-cli</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718101256564.png" alt="image-20230718101256564"> </p>
</li>
<li><p>多个端口可以：<code>redis-cli-p6379</code> </p>
</li>
<li><p>测试验证：<code>ping</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718101354992.png" alt="image-20230718101354992"> </p>
</li>
<li><p>关闭Redis</p>
<ul>
<li><p>单实例关闭：<code>redis-cli shutdown</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718101500924.png" alt="image-20230718101500924"></p>
</li>
<li><p>也可以进入终端后再关闭</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718101451815.png" alt="image-20230718101451815"> </p>
</li>
<li><p>多实例关闭，指定端口关闭：<code>redis-cli -p6379 shutdown</code></p>
</li>
</ul>
</li>
</ol>
<h2 id="Redis介绍"><a href="#Redis介绍" class="headerlink" title="Redis介绍"></a>Redis介绍</h2><p>默认16个数据库，类似数组下标从0开始，初始默认使用0号库</p>
<ul>
<li>使用命令 <code>select  &lt;dbid&gt;</code>来切换数据库。如: <code>select 8 </code></li>
<li>统一密码管理，所有库同样密码。</li>
<li>dbsize：查看当前数据库的key的数量</li>
<li>flushdb：清空当前库</li>
<li>flushall：通杀全部库</li>
</ul>
<p>多路复用是指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用select和poll函数，传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）</p>
<blockquote>
<p>串行  vs  多线程+锁（memcached） vs  单线程+多路IO复用(Redis)</p>
</blockquote>
<h1 id="常用五大数据类型"><a href="#常用五大数据类型" class="headerlink" title="常用五大数据类型"></a>常用五大数据类型</h1><h2 id="键（key）"><a href="#键（key）" class="headerlink" title="键（key）"></a>键（key）</h2><p><code>keys *</code> ：查看当前库所有key   (匹配：keys *1)</p>
<p><code>exists key</code> ：判断某个key是否存在</p>
<p><code>type key</code> ：查看key是什么类型</p>
<p><code>del key</code> ：删除指定的key数据</p>
<p><code>unlink key</code> ：根据value选择非阻塞删除，仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作。</p>
<p><code>expire key 10</code> ：为给定的key设置过期时间（10秒）</p>
<p><code>ttl key</code> ：查看还有多少秒过期，-1表示永不过期，-2表示已过期</p>
<p><code>select 0~15</code>：切换数据库0~15，默认数据库是0号数据库</p>
<p><code>dbsize</code>：查看当前数据库的key的数量</p>
<p><code>flushdb</code>：清空当前数据库</p>
<p><code>flushall</code>：通杀全部数据库</p>
<h2 id="字符串（String）"><a href="#字符串（String）" class="headerlink" title="字符串（String）"></a>字符串（String）</h2><ul>
<li><p>String是Redis最基本的类型，可以理解成与Memcached一模一样的类型，一个key对应一个value。</p>
</li>
<li><p>String类型是二进制安全的。意味着Redis的string可以包含任何数据。比如 jpg 图片或者序列化的对象。</p>
</li>
<li><p>String类型是Redis最基本的数据类型，一个Redis中字符串value最多可以是512M</p>
</li>
</ul>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p><code>set &lt;key&gt; &lt;value&gt;</code> ：添加键值对</p>
<p><code>*NX</code> ：当数据库中 key 不存在时，可以将key-value添加数据库</p>
<p><code>*XX</code>：当数据库中 key 存在时，可以将key-value添加数据库，与NX参数互斥</p>
<p><code>*EX</code>：key 的超时秒数</p>
<p><code>*PX</code>：key 的超时毫秒数，与 EX 互斥</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718154349073.png" alt="image-20230718154349073"> </p>
<p><code>get &lt;key&gt;</code> ：查询对应键值</p>
<p><code>append &lt;key&gt; &lt;value&gt;</code> ：将给定的 <code>&lt;value&gt;</code> 追加到原值的末尾</p>
<p><code>strlen &lt;key&gt;</code> ：获得值的长度</p>
<p><code>setnx &lt;key&gt; &lt;value&gt;</code> ：只有在 key 不存在时，设置 key 的值</p>
<p><code>incr &lt;key&gt;</code> ：将 key 中存储的数字值增1，只能对数字操作，如果为空，新增值为1</p>
<p><code>decr &lt;key&gt;</code> ：将 key 中存储的数字值减1，只能对数字值操作，如果为空，新增值为 -1</p>
<p><code>incrby / decrby &lt;key&gt; &lt;步长&gt;</code> ：将 key 中存储的数字值增减，自定义步长。</p>
<p><strong>原子性：</strong></p>
<p>所谓原子操作是指 不会被线程调度机制打断的操作；</p>
<p>这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch （切换到另一个线程）。</p>
<p><code>mset &lt;key1&gt; &lt;value1&gt; &lt;key2&gt; &lt;value2&gt; ...</code> ：同时设置一个或多个 key-value 对</p>
<p><code>mget &lt;key1&gt; &lt;key2&gt; &lt;key3&gt; ...</code> ：同时获取一个或多个 value</p>
<p><code>msetnx &lt;key1&gt; &lt;value1&gt; &lt;key2&gt; &lt;value2&gt; ...</code> ：同时设置一个或多个 key-value对，当且仅当所有给定 key 都不存在</p>
<p><strong>原子性：有一个失败则都失败</strong></p>
<p><code>getrange &lt;key&gt; &lt;起始位置&gt; &lt;结束位置&gt;</code> ：获得值的范围，类似java中的 substring，前包、后包</p>
<p><code>setrange &lt;key&gt; &lt;起始位置&gt; &lt;value&gt;</code> ：用 <code>&lt;value&gt;</code> 覆写 <code>&lt;key&gt;</code> 所存储的字符串值，从 &lt;起始位置&gt; 开始（<strong>从索引0开始</strong>）</p>
<p><code>setex &lt;key&gt; &lt;过期时间&gt; &lt;value&gt;</code> ：设置键值的同时，设置过期时间，单位秒。</p>
<p><code>getset &lt;key&gt; &lt;value&gt;</code> ：以新换旧，设置了新值同时获得旧值。</p>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p>String的数据结构为简单动态字符串(Simple Dynamic String,缩写SDS)。是可以修改的字符串，内部结构实现上类似于Java的ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718153747348.png" alt="image-20230718153747348"> </p>
<p>如图中所示，内部为当前字符串实际分配的空间capacity一般要高于实际字符串长度len。当字符串长度小于1M时，扩容都是加倍现有的空间，如果超过1M，扩容时一次只会多扩1M的空间。需要注意的是字符串最大长度为512M。</p>
<h2 id="列表（List）"><a href="#列表（List）" class="headerlink" title="列表（List）"></a>列表（List）</h2><p><strong>单键多值</strong></p>
<p>Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。</p>
<p>它的底层实际是个双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。</p>
<h3 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h3><p><code>lpush / rpush &lt;key&gt; &lt;value1&gt; &lt;value2&gt; &lt;value3&gt; ...</code> ：从左边 &#x2F; 右边插入一个或多个值。</p>
<p><code>lpop / rpop &lt;key&gt;</code> ：从 左边 &#x2F; 右边吐出一个值。 值在键在，值光键亡。</p>
<p><code>rpoplpush &lt;key1&gt; &lt;key2&gt;</code> ：从 <code>&lt;key1&gt;</code> 列表右边吐出一个值，插到<code>&lt;key2&gt;</code>列表左边。</p>
<p><code>lrange &lt;key&gt; &lt;start&gt; &lt;stop&gt;</code> ：按照索引下表获得元素（从左到右）</p>
<p>例如：<code>lrange k1 0 -1</code> ：0表示左边第一个，-1表示右边第一个。（0 -1 表示获取所有）</p>
<p><code>lindex &lt;key&gt; &lt;index&gt;</code> ：按照索引下标获得元素（从左到右）</p>
<p><code>llen &lt;key&gt;</code> ：获得列表长度</p>
<p><code>linsert &lt;key&gt; before / after &lt;value&gt; &lt;newvalue&gt;</code> ：在<code> &lt;value&gt;</code> 的前面 &#x2F; 后面插入 <code>&lt;newvalue&gt;</code> 插入值</p>
<p><code>lrem &lt;key&gt; &lt;n&gt; &lt;value&gt;</code> 从左边删除 n 个 value （从左到右）</p>
<p><code>lset &lt;key&gt; &lt;index&gt; &lt;value&gt;</code> ：将列表 key 下标为 index 的值替换成 value</p>
<h3 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h3><p>List的数据结构为快速链表 quickList。</p>
<p>首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构是ziplist，也即是压缩列表。</p>
<p>它将所有的元素紧挨着一起存储，分配的是一块连续的内存。</p>
<p>当数据量比较多的时候才会改成quicklist。</p>
<p>因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是 int类型的数据，结构上还需要两个额外的指针 prev 和 next。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718191446098.png" alt="image-20230718191446098"></p>
<p>Redis将链表和 ziplist 结合起来组成了quicklist。也就是将多个 ziplist 使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</p>
<h2 id="集合（Set）"><a href="#集合（Set）" class="headerlink" title="集合（Set）"></a>集合（Set）</h2><p>Redis set对外提供的功能与list类似是一个列表的功能，特殊之处在于set是可以<strong>自动排重</strong>的，当你需要存储一个列表数据，又不希望出现重复数据时，set是一个很好的选择，并且set提供了判断某个成员是否在一个set集合内的重要接口，这个也是list所不能提供的。</p>
<p>Redis的Set是string类型的无序集合。它底层其实是一个value为null的hash表，所以添加，删除，查找的**复杂度都是O(1)**。</p>
<p>一个算法，随着数据的增加，执行时间的长短，如果是O(1)，数据增加，查找数据的时间不变</p>
<h3 id="常用命令-2"><a href="#常用命令-2" class="headerlink" title="常用命令"></a>常用命令</h3><p><code>sadd &lt;key&gt; &lt;value1&gt; &lt;value2&gt; ...</code> ：将一个或多个 member 元素加入到集合 key 中，已经存在的 member 元素将被忽略</p>
<p><code>smembers &lt;key&gt;</code> ：取出该集合的所有值。</p>
<p><code>sismember &lt;key&gt; &lt;value&gt;</code> ：判断集合 <code>&lt;key&gt;</code> 是否为含有该 <code>&lt;value&gt;</code> 值，有1，没有0</p>
<p><code>scard &lt;key&gt;</code> ：返回该集合的元素个数。</p>
<p><code>srem &lt;key&gt; &lt;value1&gt; &lt;value2&gt; ...</code> ：删除集合中的某个元素</p>
<p><code>spop &lt;key&gt;</code> ：随机从该集合中吐出一个值。(删除)</p>
<p><code>srandmember &lt;key&gt; &lt;n&gt;</code> ：随机从该集合中取出 n 个值，不会从集合中删除。</p>
<p><code>smove &lt;source&gt; &lt;destination&gt; value</code> ：把集合中一个值从一个集合移动到另一个集合（source表示集合1，destination表示集合2，value表示集合1中的值）</p>
<p><code>sinter &lt;key1&gt; &lt;key2&gt;</code> ：返回两个集合的 <strong>交集</strong> 元素。</p>
<p><code>sunion &lt;key1&gt; &lt;key2&gt;</code> ：返回两个集合的 <strong>并集</strong> 元素。</p>
<p><code>sdiff &lt;key1&gt; &lt;key2&gt;</code> ：返回两个集合的 <strong>差集元素</strong> （key1 中的，不包含 key2 中的）</p>
<p><code>sintercard numkeys key [key...] [LIMIT limit]</code> ：Redis7 新命令，它不返回结果集，而只返回结果的基数。返回有所有给定集合的交际产生的集合的基数。（这个numkeys指的是比较的有几个key，如果是两个key则 <code>sintercard 2 k1 k2</code> ，返回两个集合交集的个数，后面可追加 <code>limit 数字</code> 表示限制(显示) ”数字“ 个）</p>
<h3 id="数据结构-2"><a href="#数据结构-2" class="headerlink" title="数据结构"></a>数据结构</h3><p>Set数据结构是dict字典，字典是用哈希表实现的。</p>
<p>Java中 HashSet 的内部实现使用的是 HashMap ，只不过所有的<code>value</code>都指向同一个对象。Redis的 set 结构也是一样，它的内部也使用hash结构，所有的 value 都指向同一个内部值。</p>
<h2 id="哈希（Hash）"><a href="#哈希（Hash）" class="headerlink" title="哈希（Hash）"></a>哈希（Hash）</h2><p>Redis hash 是一个键值对集合。</p>
<p>Redis hash是一个string类型的field和value的映射表，hash特别适合用于存储对象。</p>
<p>类似Java里面的Map&lt;String,Object&gt;</p>
<p>用户ID为查找的key，存储的value用户对象包含姓名，年龄，生日等信息，如果用普通的key&#x2F;value结构来存储</p>
<p>主要有以下2种存储方式：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230718195712561.png" alt="image-20230718195712561" style="zoom: 50%;" />

<h3 id="常用命令-3"><a href="#常用命令-3" class="headerlink" title="常用命令"></a>常用命令</h3><p><code>hset &lt;key&gt; &lt;field&gt; &lt;value&gt;</code> ：给<code> &lt;key&gt;</code> 集合中的 <code>&lt;field&gt; </code>键赋值 <code>&lt;value&gt;</code></p>
<p><code>hget &lt;key1&gt; &lt;field&gt;</code> ：从 <code>&lt;key1&gt;</code> 集合 <code>&lt;field&gt;</code>键 取出 其<code>value</code></p>
<p><code>hmset &lt;key1&gt; &lt;field&gt; &lt;value1&gt; &lt;field2&gt; &lt;value2&gt; ...</code> ：批量设置 hash 的值</p>
<p><code>hexists &lt;key1&gt; &lt;field&gt;</code> ：查看哈希表 key 中，给定域 field 是否存在</p>
<p><code>hkeys &lt;key&gt;</code> ：列出该 hash 集合的所有 field键</p>
<p><code>hvals &lt;key&gt;</code> ：列出该 hash 集合的所有 value值</p>
<p><code>hincrby &lt;key&gt; &lt;field&gt; &lt;increment&gt;</code> ：为 哈希表 key 中的域 field 的值加上增量（加减） 1 -1（increment表示增量的值）</p>
<p><code>hsetnx &lt;key&gt; &lt;field&gt; &lt;value&gt;</code> ：将哈希表 key 中的域 field 的值设置为 value，当且仅当域 field 不存在</p>
<h3 id="数据结构-3"><a href="#数据结构-3" class="headerlink" title="数据结构"></a>数据结构</h3><p>Hash 类型对应的数据结构是两种：ziplist（压缩列表），hashtable（哈希表）。当 field-value 长度较短且个数较少时，使用ziplist，否则使用 hashtable。</p>
<h2 id="有序集合-Zset-shorted-set"><a href="#有序集合-Zset-shorted-set" class="headerlink" title="有序集合 Zset(shorted set)"></a>有序集合 Zset(shorted set)</h2><p>Redis有序集合zset与普通集合set非常相似，是一个没有重复元素的字符串集合。</p>
<p>不同之处是有序集合的每个成员都关联了一个<strong>评分（score）</strong>,这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。集合的成员是唯一的，但是评分可以是重复了 。</p>
<p>因为元素是有序的, 所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</p>
<p>访问有序集合的中间元素也是非常快的,因此你能够使用有序集合作为一个没有重复成员的智能列表。</p>
<h3 id="常用命令-4"><a href="#常用命令-4" class="headerlink" title="常用命令"></a>常用命令</h3><p><code>zadd &lt;key&gt; &lt;score1&gt; &lt;value1&gt; &lt;score2&gt; &lt;value2&gt; ...</code>  ：将一个或多个 member 元素及其 score 值加入到有序集 key 当中</p>
<p><code>zrange &lt;key&gt; &lt;start&gt; &lt;stop&gt; [WITHSCORES]</code> ：返回有序集 key 中，下标注 <code>&lt;start&gt; &lt;stop&gt; </code>之间的元素，带 WITHSCORES，可以让分数一起和值返回到结果集。</p>
<p><code>zrangebyscore key min max [withscores] [limit offset count]</code> ：返回有序集 key 中，所有 score 值介于 min 和 max 之间（包括等于 min 或 max）的成员。有序集成员按 score 值递增（从小到大）次序排列。<code>limit offset count</code> 表示从 offset开始走count步。<code>zrangebyscore key (min max ...</code> ：表示不包括min值，从小到大排列。</p>
<p><code>zrevrangebyscore key max min [withscores] [limit offset count]</code> ：同上，改为从大到小排列。</p>
<p><code>zincrby &lt;key&gt; &lt;increment&gt; &lt;value&gt;</code> ：为元素的 score 加上增量</p>
<p><code>zrem &lt;key&gt; &lt;value&gt;</code> ：删除该集合下，指定的元素</p>
<p><code>zcount &lt;key&gt; &lt;min&gt; &lt;max&gt;</code> ：统计该集合，分数区间内的元素个数</p>
<p><code>zmpop numkeys key [key ...] &lt;MIN | MAX&gt; [COUNT count]</code> ：从键名列表中的第一个非空排序集中弹出一个或多个元素，它们是成员分数对。<code>zmpop 1 zset1 MIN</code> ：弹出scores最小的那个数。</p>
<p><code>zscore &lt;key&gt; &lt;value&gt;</code> ：获取元素的分数（score）</p>
<p><code>zcard key</code> ：获取集合中元素的数量</p>
<p><code>zincrby &lt;key&gt; &lt;increment&gt; &lt;value&gt;</code> ：增加某个元素的分数</p>
<p><code>zcount &lt;key&gt; min max</code> ：获得指定分数范围内的元素个数</p>
<p><code>zrank &lt;key&gt; &lt;value&gt;</code> ：返回该值在集合中的排名，从 0 开始</p>
<p><code>zrevrank &lt;key&gt; &lt;value&gt;</code> ：逆序返回在集合中的排名</p>
<h3 id="数据结构-4"><a href="#数据结构-4" class="headerlink" title="数据结构"></a>数据结构</h3><p>SortedSet (zset) 是Redis提供的一个非常特别的数据结构，一方面它等价于 Java的数据结构 Map&lt;String, Double&gt;，可以给每一个元素value赋予一个权重score，另一方面它又类似于 TreeSet，内部的元素会按照权重score进行排序，可以得到每个元素的名次，还可以通过score的范围来获取元素的列表。</p>
<p>zset底层使用了两个数据结构</p>
<p>（1）hash，hash的作用就是关联元素value和权重score，保障元素value的唯一性，可以通过元素value找到相应的score值。</p>
<p>（2）跳跃表，跳跃表的目的在于给元素value排序，根据score的范围获取元素列表。</p>
<h1 id="新数据类型"><a href="#新数据类型" class="headerlink" title="新数据类型"></a>新数据类型</h1><h2 id="位图（Bitmaps）"><a href="#位图（Bitmaps）" class="headerlink" title="位图（Bitmaps）"></a>位图（Bitmaps）</h2><p>Redis提供了Bitmaps这个“数据类型”可以实现对位的操作：</p>
<ul>
<li><p>Bitmaps本身不是一种数据类型， 实际上它就是字符串（key-value） ， 但是它可以对字符串的位进行操作。</p>
</li>
<li><p>Bitmaps单独提供了一套命令， 所以在Redis中使用Bitmaps和使用字符串的方法不太相同。 可以把Bitmaps想象成一个以位为单位的数组， 数组的每个单元只能存储0和1， 数组的下标在Bitmaps中叫做偏移量。</p>
</li>
</ul>
<h3 id="常用命令-5"><a href="#常用命令-5" class="headerlink" title="常用命令"></a>常用命令</h3><ul>
<li><p><code>setbit &lt;key&gt; &lt;offset&gt; &lt;value&gt;</code> ：设置 Bitmaps 中某个偏移量的值（0或1），<code>*offset</code>：偏移量从 0 开始</p>
</li>
<li><p><code>getbit &lt;key&gt; &lt;offset&gt;</code> ：获取 Bitmaps 中某个偏移量的值，例如获取user中的第7位的值，<code>getbit user 6</code></p>
</li>
<li><p><code>bitcount &lt;key&gt; [start end]</code> ：统计字符串从 start 字节到 end 字节比特值为 1 的数量</p>
<p><code>bitcount bit1 0 -1</code> ：统计 bit1 中所有字节比特值为 1 的数量</p>
</li>
<li><p><code>bitop and(or/not/xor) &lt;destkey&gt; [key...]</code> ：bitop 是一个复合操作，它可以做多个 Bitmaps 的 and（交集）、or（并集）、not（非）、xor（异或）操作并将结果保存在 destkey 中。<br><strong>案例：</strong></p>
<ul>
<li><p>两天访问网站的 userid&#x3D;1,2,5,9。</p>
<pre class="line-numbers language-none"><code class="language-none">setbit unique:users:20231104 1 1
setbit unique:users:20231104 2 1
setbit unique:users:20231104 5 1
setbit unique:users:20231104 9 1

setbit unique:users:20231105 0 1
setbit unique:users:20231105 1 1
setbit unique:users:20231105 4 1
setbit unique:users:20231105 9 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>计算出两天都访问过网站的用户数量</p>
<pre class="line-numbers language-none"><code class="language-none">bitop and unique:users:and:20231103_04 unique:users:20231103 unique:users:20231104<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719101105719.png" alt="image-20230719101105719"></p>
</li>
<li><p>计算出任意一天都访问过网站的用户数量（例如月活跃），可以使用 or 求并集</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719101155859.png" alt="image-20230719101155859"></p>
</li>
</ul>
</li>
</ul>
<h3 id="Bitmaps-与-set-对比"><a href="#Bitmaps-与-set-对比" class="headerlink" title="Bitmaps 与 set 对比"></a>Bitmaps 与 set 对比</h3><p>假设网站有1亿用户， 每天独立访问的用户有5千万， 如果每天用集合类型和Bitmaps分别存储活跃用户可以得到表</p>
<p><strong>set 和 Bitmaps 存储一天活跃用户对比：</strong></p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>每个用户id占用空间</th>
<th>需要存储的用户量</th>
<th>全部内存量</th>
</tr>
</thead>
<tbody><tr>
<td>集合类型</td>
<td>64位</td>
<td>50000000</td>
<td>64位*50000000 &#x3D; 400MB</td>
</tr>
<tr>
<td>Bitmaps</td>
<td>1位</td>
<td>100000000</td>
<td>1位*100000000 &#x3D; 12.5MB</td>
</tr>
</tbody></table>
<p>很明显， 这种情况下使用Bitmaps能节省很多的内存空间， 尤其是随着时间推移节省的内存还是非常可观的</p>
<p><strong>set 和 Bitmaps 存储独立用户空间对比</strong></p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>一天</th>
<th>一个月</th>
<th>一年</th>
</tr>
</thead>
<tbody><tr>
<td>集合类型</td>
<td>400MB</td>
<td>12GB</td>
<td>144GB</td>
</tr>
<tr>
<td>Bitmaps</td>
<td>12.5MB</td>
<td>375MB</td>
<td>4.5GB</td>
</tr>
</tbody></table>
<p>但Bitmaps并不是万金油， 假如该网站每天的独立访问用户很少， 例如只有10万（大量的僵尸用户） ， 那么两者的对比如下表所示， 很显然， 这时候使用Bitmaps就不太合适了， 因为基本上大部分位都是0。</p>
<p><strong>set 和 Bitmaps 存储一天活跃用户对比（独立用户比较少）</strong></p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>每个userid占用空间</th>
<th>需要存储的用户量</th>
<th>全部内存量</th>
</tr>
</thead>
<tbody><tr>
<td>集合类型</td>
<td>64位</td>
<td>100000</td>
<td>64位*100000 &#x3D; 800KB</td>
</tr>
<tr>
<td>Bitmaps</td>
<td>1位</td>
<td>100000000</td>
<td>1位*100000000 &#x3D; 12.5MB</td>
</tr>
</tbody></table>
<h2 id="基数统计（HyperLogLog）"><a href="#基数统计（HyperLogLog）" class="headerlink" title="基数统计（HyperLogLog）"></a>基数统计（HyperLogLog）</h2><p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<p><strong>什么是基数?</strong></p>
<p>比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数(不重复元素)为5。 基数估计就是在误差可接受的范围内，快速计算基数。</p>
<h3 id="常用命令-6"><a href="#常用命令-6" class="headerlink" title="常用命令"></a>常用命令</h3><ul>
<li><p><code>pfadd &lt;key&gt; &lt;element&gt; [element ...]</code> ：添加指定元素到 HyperLogLog 中，将所有元素添加到指定HyperLogLog数据结构中。如果执行命令后HLL估计的近似基数发生变化，则返回1，否则返回0。</p>
<p><strong>实例：</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719102449105.png" alt="image-20230719102449105" style="zoom:67%;" /> 
</li>
<li><p><code>pfcount &lt;key&gt; [key...]</code> ：计算 HLL 的近似技术，可以计算多个 HLL，比如用 HLL 存储每天的 UV，计算一周的 UV 可以使用 7 天的 UV 合并计算即可（去重）</p>
<p><strong>实例：</strong> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719102259725.png" alt="image-20230719102259725"> </p>
</li>
<li><p><code>pfmerge &lt;destkey&gt; &lt;sourcekey&gt; [sourcekey...]</code> ：将一个或多个 HLL 合并后的结果存储在另一个 HLL 中，比如每月用户可以使用每天的活跃用户来合并计算可得</p>
<p><strong>实例：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719102551778.png" alt="image-20230719102551778"></p>
</li>
</ul>
<h2 id="地理空间（Geospatial）"><a href="#地理空间（Geospatial）" class="headerlink" title="地理空间（Geospatial）"></a>地理空间（Geospatial）</h2><p>Redis 3.2 中增加了对GEO类型的支持。GEO，Geographic，地理信息的缩写。该类型，就是元素的2维坐标，在地图上就是经纬度。redis基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度Hash等常见操作。</p>
<h3 id="常用命令-7"><a href="#常用命令-7" class="headerlink" title="常用命令"></a>常用命令</h3><ul>
<li><p><code>geoadd &lt;key&gt; &lt;longitude&gt; &lt;latitude&gt; &lt;member&gt; [longitude latitude member ...]</code> ：添加地理位置（经度、纬度、名称）</p>
<p><strong>实例：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719103012365.png" alt="image-20230719103012365"></p>
<p>两极无法直接添加，一般会下载城市数据，直接通过 Java 程序一次性导入。有效的经度从 -180 度到 180 度。有效的纬度从 -85.05112878 度到 85.05112878 度。当坐标位置超出指定范围时，该命令将会返回一个错误。</p>
<p>已经添加的数据，是无法再次往里面添加的。</p>
</li>
<li><p><code>geopos &lt;key&gt; &lt;member&gt; [member...]</code> ：获得指定地区的坐标值</p>
<p><strong>实例：</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719103108542.png" alt="image-20230719103108542" style="zoom: 67%;" /> 
</li>
<li><p><code>geodist &lt;key&gt; &lt;member1&gt; &lt;member2&gt; [m | km | ft | mi]</code> ：获取两个位置之间的直线距离</p>
<p><strong>实例：</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719103217152.png" alt="image-20230719103217152" style="zoom:67%;" /> 

<p><strong>单位：</strong></p>
<blockquote>
<p>m 表示单位为米[默认值]。</p>
<p>km 表示单位为千米。</p>
<p>mi 表示单位为英里。</p>
<p>ft 表示单位为英尺。</p>
<p>如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位</p>
</blockquote>
</li>
<li><p><code>georadius &lt;key&gt; &lt;longitude&gt; &lt;latitude&gt; radius m|km|ft|mi</code> ：以给定的经纬度为中心，找出某一半径内的元素<br>经度  纬度  距离  单位</p>
<p><strong>实例：</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719103428037.png" alt="image-20230719103428037" style="zoom:67%;" /> 
</li>
<li><p><code>geohash &lt;key&gt; [member [member...]]</code> ：返回坐标的geohash表示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719105819439.png" alt="image-20230719105819439"></p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719103550333.png" alt="image-20230719103550333"></p>
<h2 id="流（Stream）"><a href="#流（Stream）" class="headerlink" title="流（Stream）"></a>流（Stream）</h2><p>Stream 实现 消息队列，他支持消息的持久化、支持自动生成全局唯一 ID、支持 ack 确认消息的模式、支持消费组模式等，让消息更加的稳定和可靠</p>
<p><strong>Redis 消息队列 的两种方案</strong></p>
<ul>
<li><p>List 实现消息队列</p>
<p>按照插入顺序排序，你可以添加一个元素到列表的头部（左边）或者尾部（右边）。</p>
<p>所以常用来做异步队列使用，将需要延后处理的任务结构体序列化成字符串塞进 Redis 的列表，另一个线程从这个列表中轮询数据进行处理。</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230309213659075.png" alt="image-20230309213659075"></p>
<ul>
<li>List实现方式其实就是点对点的模式</li>
</ul>
<p><strong>Pub&#x2F;sub</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230309213958521.png" alt="image-20230309213958521"></p>
<p>Redis 发布订阅（pub&#x2F;sub） 有个缺点就是消息无法持久化，如果出现 网络断开、Redis 宕机等，消息就会被丢弃，而且也没有 ack 机制来保证数据的可靠性，假设一个消费者都没有，那么消息就会被丢弃了。</p>
<p>Redis 5.0 版本新增了一个更强大的 数据结构 – Stream</p>
<blockquote>
<p> <strong>redis 版的 MQ消息中间件 + 阻塞队列</strong></p>
</blockquote>
<h3 id="底层结构和原理"><a href="#底层结构和原理" class="headerlink" title="底层结构和原理"></a>底层结构和原理</h3><p>Stream 结构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230309214654127.png" alt="image-20230309214654127"></p>
<blockquote>
<p>一个消息链表，将所有加入的消息都串起来，每个消息都有唯一一个的 ID 和对应的内容</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230309214754029.png" alt="image-20230309214754029"></p>
<h3 id="常用命令-8"><a href="#常用命令-8" class="headerlink" title="常用命令"></a>常用命令</h3><p><strong>队列相关指令</strong></p>
<table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">xadd</td>
<td align="left">添加消息到队列末尾</td>
</tr>
<tr>
<td align="left">xtrim</td>
<td align="left">删除消息</td>
</tr>
<tr>
<td align="left">xdel</td>
<td align="left">删除消息</td>
</tr>
<tr>
<td align="left">xlen</td>
<td align="left">获取 stream 中的消息长度</td>
</tr>
<tr>
<td align="left">xrange</td>
<td align="left">获取消息列表（可以指定范围），忽略删除的消息</td>
</tr>
<tr>
<td align="left">xrevrange</td>
<td align="left">和 xranger 相比，区别在于 反向获取，ID 从大到小</td>
</tr>
<tr>
<td align="left">xread</td>
<td align="left">获取消息（阻塞&#x2F;非阻塞），返回大于指定ID 的消息</td>
</tr>
</tbody></table>
<p><strong>消费组相关指令</strong></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>xgroup create</td>
<td>创建消费组</td>
</tr>
<tr>
<td>xreadgroup group</td>
<td>读取消费组中的消息</td>
</tr>
<tr>
<td>xack</td>
<td>ack 消息，消息被标记为 “已处理”</td>
</tr>
<tr>
<td>xgroup setid</td>
<td>设置消费组最后递送消息的 id</td>
</tr>
<tr>
<td>xgroup delconsumer</td>
<td>删除消费组</td>
</tr>
<tr>
<td>xpending</td>
<td>打印待处理消息的详细信息</td>
</tr>
<tr>
<td>xclaim</td>
<td>转移消息的归属权（长期未被处理&#x2F;无法处理的消息，转交为其他消费组进行处理）</td>
</tr>
<tr>
<td>xinfo</td>
<td>打印 stream &#x2F; consumer &#x2F;group 的详细消息</td>
</tr>
<tr>
<td>xinfo groups</td>
<td>打印消费者组的详细消息</td>
</tr>
<tr>
<td>xinfo stream</td>
<td>打印 stream 的详细消息</td>
</tr>
</tbody></table>
<p><strong>四个特殊符号</strong></p>
<ul>
<li><code>- +</code> ：最小和最大可能出现的ID</li>
<li><code>$</code> ：只表示消费新的消息，当前流量中最大的ID，可用于将来要到来的消息</li>
<li><code>&gt;</code> ：用于 xreadgroup 命令，表示迄今位置还没有发送给组中使用者的消息，会更新消费组的最后ID</li>
<li><code>*</code> ：用于 xadd 命令，让系统自动生成 id</li>
</ul>
<p><strong>命令使用</strong></p>
<ul>
<li><p><code>xadd &lt;key&gt; &lt;id&gt; &lt;field&gt; &lt;value&gt; [field value...]</code> ：使用 xadd 向队列添加消息，如果指定的队列不存在，则创建一个队列。</p>
<ul>
<li>key ：队列名称，如果不存在就创建</li>
<li>id ：消息 id，我们使用 <code>*</code> 表示由 redis 生成，可以自定义，但是要自己保证递增性。</li>
<li>field vlaue ：记录。</li>
</ul>
<pre class="line-numbers language-xadd实例" data-language="xadd实例"><code class="language-xadd实例">redis&gt; XADD mystream * name Sara surname OConnor
 	&quot;1601372323627-0&quot;
  
redis&gt; XADD mystream * field1 value1 field2 value2 field3 value3
  	&quot;1601372323627-1&quot;
  
redis&gt; XLEN mystream
  	(integer) 2
  
redis&gt; XRANGE mystream - +
    1) 1) &quot;1601372323627-0&quot;
       2) 1) &quot;name&quot;
          2) &quot;Sara&quot;
          3) &quot;surname&quot;
          4) &quot;OConnor&quot;
    2) 1) &quot;1601372323627-1&quot;
       2) 1) &quot;field1&quot;
          2) &quot;value1&quot;
          3) &quot;field2&quot;
          4) &quot;value2&quot;
          5) &quot;field3&quot;
          6) &quot;value3&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>xtrim &lt;key&gt; maxlen [~] count</code> ：使用 xtrim 对流进行修剪，限制长度</p>
<ul>
<li>key ：队列名称</li>
<li>maxlen ：长度</li>
<li>count ：数量</li>
</ul>
<pre class="line-numbers language-xtrim实例" data-language="xtrim实例"><code class="language-xtrim实例">127.0.0.1:6379&gt; XADD mystream * field1 A field2 B field3 C field4 D
	&quot;1601372434568-0&quot;

127.0.0.1:6379&gt; XTRIM mystream MAXLEN 2
	(integer) 0
	
127.0.0.1:6379&gt; XRANGE mystream - +
    1) 1) &quot;1601372434568-0&quot;
       2) 1) &quot;field1&quot;
          2) &quot;A&quot;
          3) &quot;field2&quot;
          4) &quot;B&quot;
          5) &quot;field3&quot;
          6) &quot;C&quot;
          7) &quot;field4&quot;
          8) &quot;D&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>xdel &lt;key&gt; id [id ...]</code> ：使用 xdel 删除消息</p>
<ul>
<li>key ：队列名称</li>
<li>id ：消息 id</li>
</ul>
<pre class="line-numbers language-xdel实例" data-language="xdel实例"><code class="language-xdel实例">&gt; XADD mystream * a 1
	1538561698944-0
	
&gt; XADD mystream * b 2
	1538561700640-0
	
&gt; XADD mystream * c 3
	1538561701744-0
	
&gt; XDEL mystream 1538561700640-0
	(integer) 1
	
127.0.0.1:6379&gt; XRANGE mystream - +
    1) 1) 1538561698944-0
       2) 1) &quot;a&quot;
          2) &quot;1&quot;
    2) 1) 1538561701744-0
       2) 1) &quot;c&quot;
          2) &quot;3&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>xlen &lt;key&gt;</code> ：使用 xlen 获取流包含的元素数量，即消息长度</p>
<pre class="line-numbers language-xlen实例" data-language="xlen实例"><code class="language-xlen实例">redis&gt; XADD mystream * item 1
	&quot;1601372563177-0&quot;
redis&gt; XADD mystream * item 2
	&quot;1601372563178-0&quot;
redis&gt; XADD mystream * item 3
	&quot;1601372563178-1&quot;
	
redis&gt; XLEN mystream
	(integer) 3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>xrange &lt;key&gt; &lt;start&gt; &lt;end&gt; [COUNT count]</code> ：使用 xrange 获取消息列表</p>
<ul>
<li>key ：队列名</li>
<li>start ：开始值，<code>-</code> 表示最小值</li>
<li>end ：结束值，<code>+</code> 表示最大值</li>
<li>count ：数量</li>
</ul>
<pre class="line-numbers language-xrange实例" data-language="xrange实例"><code class="language-xrange实例">redis&gt; XADD writers * name Virginia surname Woolf
	&quot;1601372577811-0&quot;
	
redis&gt; XADD writers * name Jane surname Austen
	&quot;1601372577811-1&quot;
	
redis&gt; XADD writers * name Toni surname Morrison
	&quot;1601372577811-2&quot;
	
redis&gt; XADD writers * name Agatha surname Christie
	&quot;1601372577812-0&quot;
	
redis&gt; XADD writers * name Ngozi surname Adichie
	&quot;1601372577812-1&quot;
	
redis&gt; XLEN writers
	(integer) 5
	
redis&gt; XRANGE writers - + COUNT 2
    1) 1) &quot;1601372577811-0&quot;
       2) 1) &quot;name&quot;
          2) &quot;Virginia&quot;
          3) &quot;surname&quot;
          4) &quot;Woolf&quot;
    2) 1) &quot;1601372577811-1&quot;
       2) 1) &quot;name&quot;
          2) &quot;Jane&quot;
          3) &quot;surname&quot;
          4) &quot;Austen&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>xrevrange &lt;key&gt; &lt;end&gt; &lt;start&gt; [COUNT count]</code> ：使用 xrevrange 获取消息列表，会自动过滤已经删除的消息</p>
<ul>
<li>key ：队列名</li>
<li>end ：结束值，<code>+</code> 表示最大值</li>
<li>start ：开始值，<code>-</code> 表示最小值</li>
<li>count ：数量</li>
</ul>
<pre class="line-numbers language-xrevrange实例" data-language="xrevrange实例"><code class="language-xrevrange实例">redis&gt; XADD writers * name Virginia surname Woolf
	&quot;1601372731458-0&quot;
	
redis&gt; XADD writers * name Jane surname Austen
	&quot;1601372731459-0&quot;
	
redis&gt; XADD writers * name Toni surname Morrison
	&quot;1601372731459-1&quot;
	
redis&gt; XADD writers * name Agatha surname Christie
	&quot;1601372731459-2&quot;
	
redis&gt; XADD writers * name Ngozi surname Adichie
	&quot;1601372731459-3&quot;
	
redis&gt; XLEN writers
	(integer) 5

redis&gt; XREVRANGE writers + - COUNT 1
1) 1) &quot;1601372731459-3&quot;
   2) 1) &quot;name&quot;
      2) &quot;Ngozi&quot;
      3) &quot;surname&quot;
      4) &quot;Adichie&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>xread [COUNT count] [BLOCK milliseconds]  stream &lt;key&gt; [key ...] &lt;id&gt; [id...]</code> ：使用 xread 以阻塞或非阻塞方式获取消息列表。</p>
<ul>
<li>count ：数量</li>
<li>milliseconds ：可选，阻塞毫秒数，没有设置就是非阻塞模式</li>
<li>key ：队列名</li>
<li>id ：消息 id</li>
</ul>
<pre class="line-numbers language-xread实例" data-language="xread实例"><code class="language-xread实例"># 从 Stream 头部读取两条消息
&gt; XREAD COUNT 2 STREAMS mystream writers 0-0 0-0
    1) 1) &quot;mystream&quot;
       2) 1) 1) 1526984818136-0
             2) 1) &quot;duration&quot;
                2) &quot;1532&quot;
                3) &quot;event-id&quot;
                4) &quot;5&quot;
                5) &quot;user-id&quot;
                6) &quot;7782813&quot;
          2) 1) 1526999352406-0
             2) 1) &quot;duration&quot;
                2) &quot;812&quot;
                3) &quot;event-id&quot;
                4) &quot;9&quot;
                5) &quot;user-id&quot;
                6) &quot;388234&quot;
    2) 1) &quot;writers&quot;
       2) 1) 1) 1526985676425-0
             2) 1) &quot;name&quot;
                2) &quot;Virginia&quot;
                3) &quot;surname&quot;
                4) &quot;Woolf&quot;
          2) 1) 1526985685298-0
             2) 1) &quot;name&quot;
                2) &quot;Jane&quot;
                3) &quot;surname&quot;
                4) &quot;Austen&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>非阻塞</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230309222228782.png" alt="image-20230309222228782"></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230309222258355.png" alt="image-20230309222258355" style="zoom: 33%;" /> 

<p><strong>阻塞</strong></p>
<p>redis-cli 连接第二个 客户端</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230309222343107.png" alt="image-20230309222343107"></p>
</li>
<li><p><code>xgroup [create key groupname id-or-$] [setid &lt;key&gt; &lt;groupname&gt; id-or-$] [destroy &lt;key&gt; &lt;groupname&gt;] [delconsumer &lt;key&gt; &lt;groupname&gt; &lt;consumername&gt;]</code> ：使用 xgroup create 创建消费者组</p>
<ul>
<li>key ：队列名称，如果不存在就创建</li>
<li>groupname ：组名</li>
<li>$ ：表示从尾部开始消费，只接受新消息，当前 Stream 消息会全部忽略</li>
</ul>
<p><strong>从头开始消费：</strong></p>
<p><code>xgroup create mystream consumer-group-name 0-0</code> </p>
<p><strong>从尾部开始消费：</strong></p>
<p><code>xgroup create mystream consumer-group-name $</code></p>
</li>
<li><p><code>xreadgroup GROUP &lt;group&gt; &lt;consumer&gt; [COUNT count] [BLOCK milliseconds] [NOACK] streams &lt;key&gt; [key...] id [id...]</code> ：使用 xreadgroup group 读取消费组中的消息</p>
<ul>
<li>group ：消费组名</li>
<li>consumer ：消费者名</li>
<li>count ：读取数量</li>
<li>milliseconds ：阻塞毫秒数</li>
<li>key ：队列名</li>
<li>id ：消息 id</li>
</ul>
<p>例：<code>xreadgroup GROUP consumer-group-name consumer-name COUNT 1 STREAMS mystream &gt;</code></p>
</li>
</ul>
<h2 id="位域（bitfield）"><a href="#位域（bitfield）" class="headerlink" title="位域（bitfield）"></a>位域（bitfield）</h2><p>官网 ： <a target="_blank" rel="noopener" href="https://redis.com.cn/commands/bitfield.html">https://redis.com.cn/commands/bitfield.html </a></p>
<ol>
<li>位域修改</li>
<li>溢出控制</li>
</ol>
<blockquote>
<p>将一个 Redis 字符串看做是 <strong>一个有二进制位组成的数组</strong>，并能对 变长位宽和任意没有字节对齐的指定整型位域进行寻址和修改</p>
</blockquote>
<p><strong>命令：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230309223404208.png" alt="image-20230309223404208"></p>
<p><code>BITFIELD key [GET type offset] [SET type offset value] [INCRBY type offset increment] [OVERFLOW WRAP|SAT|FAIL]</code></p>
<h1 id="Redis持久化（RDB-AOF）"><a href="#Redis持久化（RDB-AOF）" class="headerlink" title="Redis持久化（RDB + AOF）"></a>Redis持久化（RDB + AOF）</h1><h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><p>在指定的时间间隔内将内存中的数据集快照写入磁盘， 也就是Snapshot快照，它恢复时是将快照文件直接读到内存里</p>
<p><strong>备份执行：</strong></p>
<ul>
<li><p>Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到 一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。 </p>
</li>
<li><p>整个过程中，主进程是不进行任何IO操作的，这就确保了极高的性能 如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。</p>
</li>
<li><p>RDB的缺点是：最后一次持久化后的数据可能丢失。</p>
</li>
<li><p>RDB 保存到磁盘的文件叫 dump.rdb</p>
</li>
</ul>
<p><strong>RDB持久化流程</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720082913468.png" alt="image-20230720082913468"></p>
<h3 id="Fork"><a href="#Fork" class="headerlink" title="Fork"></a>Fork</h3><p>Fork的作用是复制一个与当前进程一样的进程。新进程的所有数据（变量、环境变量、程序计数器等） 数值都和原进程一致，但是是一个全新的进程，并作为原进程的子进程。</p>
<p>在Linux程序中，fork ( ) 会产生一个和父进程完全相同的子进程，但子进程在此后多会 exec 系统调用，出于效率考虑，Linux中引入了<strong>写时复制技术</strong>。</p>
<p>一般情况父进程和子进程会共用同一段物理内存，只有进程空间的各段的内容要发生变化时，才会将父进程的内容复制一份给子进程。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>使用 <code>vim /myredis/redis7.conf</code> 进入redis7.conf 界面，</p>
<ul>
<li><p>redis 6.0.16 版本以下，在 redis.conf 配置文件中的 snapshot 下配置 save 参数，来触发 redis 的 rdb 持久化条件，比如 <code>save m n </code>： 表示 m 秒内 数据集存在 n 次修改时，自动触发 bgsave。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310152748384.png" alt="image-20230310152748384"></p>
</li>
</ul>
<ul>
<li><p>redis 6.2 以及 redis7.0.0</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310171018738.png" alt="image-20230310171018738" style="zoom: 50%;" /></li>
</ul>
<p><strong>自动触发：</strong></p>
<ul>
<li><p>在 redis7.conf 中配置 save</p>
</li>
<li><p>修改 dump 文件的保存位置</p>
<ul>
<li><p>默认</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310171505245.png" alt="image-20230310171505245" style="zoom: 50%;" />
</li>
<li><p>自定义修改为 &#x2F;myredis&#x2F;dum6379.rdb ，可以在redis里面使用 <code>config get dir</code> 获取目录</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310171801493.png" alt="image-20230310171801493" style="zoom: 50%;" /> 

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310172126770.png" alt="image-20230310172126770" style="zoom: 50%;" /></li>
</ul>
</li>
</ul>
<ul>
<li><p>修改 dump 文件名称</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310172237300.png" alt="image-20230310172237300"></p>
</li>
<li><p>触发备份</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720090553799.png" alt="image-20230720090553799"></p>
</li>
<li><p>恢复文件</p>
<ul>
<li>将备份文件 （dump.rdb） 移动到 redis 安装目录并启动服务即可</li>
<li>备份成功后故意 用 flushdb 清空 redis，看是否可以恢复数据</li>
<li>执行 flushall&#x2F;flushdb 命令也会产生 dump.rdb 文件。但里面是空的。无意义</li>
</ul>
</li>
<li><p>物理恢复文件，一定要 服务和备份 <strong>分机隔离</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310173458197.png" alt="image-20230310173458197"></p>
</li>
</ul>
<p><font color='red'><strong>注意：</strong></font> </p>
<p>不可以把 备份文件 dump.rdb 和生产 redis 服务器放在同一台机器，必须分开各自存储，以防生产机物理损坏后备份文件也挂了</p>
<p><strong>手动触发：</strong></p>
<p>redis 提供了两个命令来生成 rdb 文件，分别是 save 和 bgsave</p>
<ul>
<li><p>save</p>
<ul>
<li><p>在主程序中执行 <strong>会阻塞</strong> 当前 redis 服务器，直到持久化工作完成</p>
<p>执行 save 命令期间，redis 不能处理 其他命令，<strong>线上禁止使用</strong> </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310174335493.png" alt="image-20230310174335493" style="zoom:50%;" /> 

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310174355231.png" alt="image-20230310174355231"></p>
</li>
</ul>
</li>
<li><p>bgsave（默认，推荐）</p>
<ul>
<li><p>redis 会在后台异步进行 快照操作， <strong>不阻塞</strong> 快照同时还可以快速响应客户端的请求，该触发方式会 fork 一个子进程，由子进程复制持久化过程</p>
</li>
<li><p>在 Linux 程序中，fork（）会产生 一个父进程完全相同的子进程，但子进程在此后多会 exec 系统调用，出于效率考虑，尽量避免膨胀</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310174957853.png" alt="image-20230310174957853" style="zoom: 50%;" /> 

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310175023057.png" alt="image-20230310175023057"></p>
</li>
</ul>
</li>
<li><p>lastsave</p>
<ul>
<li>可以 通过 lastsave 命令获取最后一次成功执行快照的时间</li>
</ul>
</li>
</ul>
<h3 id="检查和修复-dump-rdb-文件"><a href="#检查和修复-dump-rdb-文件" class="headerlink" title="检查和修复 dump.rdb 文件"></a>检查和修复 dump.rdb 文件</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310181547571.png" alt="image-20230310181547571"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310182755358.png" alt="image-20230310182755358"></p>
<h4 id="触发RDB快照的情况"><a href="#触发RDB快照的情况" class="headerlink" title="触发RDB快照的情况"></a>触发RDB快照的情况</h4><ol>
<li>配置文件中默认的快照配置</li>
<li>手动 save &#x2F; bgsave 命令</li>
<li>执行 flushall &#x2F; flushdb 命令也会产生 dump.rdb 文件</li>
<li>执行 shutdown 且没有设置开启 AOF 持久化</li>
<li>主从复制时，主节点自动触发</li>
</ol>
<h4 id="禁用快照"><a href="#禁用快照" class="headerlink" title="禁用快照"></a>禁用快照</h4><ol>
<li><p>动态所有停止 RDB 保存规则的方法：<code>redis-cli config set save &quot;&quot;</code> </p>
</li>
<li><p>快照禁用：</p>
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719170049534.png" alt="image-20230719170049534" style="zoom:67%;" /></li>
</ol>
<h3 id="RDB优化参数"><a href="#RDB优化参数" class="headerlink" title="RDB优化参数"></a>RDB优化参数</h3><ul>
<li><p><code>save &lt;seconds&gt; &lt;changes&gt;</code> </p>
</li>
<li><p><code>dbfilename</code></p>
</li>
<li><p><code>dir</code></p>
</li>
<li><p><code>stop-writes-on bgsave-error</code>  (使用默认即可)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719170530068.png" alt="image-20230719170530068"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719170542522.png" alt="image-20230719170542522"></p>
</li>
<li><p><code>rdbcompression</code> （使用默认即可）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719170615191.png" alt="image-20230719170615191"></p>
</li>
<li><p><code>rdbchecksum</code> （使用默认即可）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719170659221.png" alt="image-20230719170659221"></p>
</li>
<li><p><code>rdb-del-sync-files</code>  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230719170749286.png" alt="image-20230719170749286"></p>
</li>
</ul>
<h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><p><strong>官网介绍</strong></p>
<p>以日志的形式来记录每个写操作，将Redis执行过的所有写指令记录下来（读操作不记录）, 只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后热行一次以完成数据的恢复工作</p>
<p>默认情况下，redis是没有开启 AOF(append only file) 的。 开启AOF功能需要设置配置：appendonly  yes</p>
<p>AOF保存的是 appendonly.aof 文件</p>
<h3 id="AOF持久化工作流程"><a href="#AOF持久化工作流程" class="headerlink" title="AOF持久化工作流程"></a>AOF持久化工作流程</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720092859059.png" alt="image-20230720092859059"></p>
<ul>
<li>Client作为命令的来源，会有多个源头以及源源不断的请求命令。 </li>
<li>在这些命令到达Redis Server 以后并不是直接写入AOF文件，会将其这些命令先放入AOF缓存中进行保存。这里的AOF缓冲 区实际上是内存中的一片区域，存在的目的是当这些命令达到一定量以后再写入磁盘，避免频繁的磁盘IO操作。 </li>
<li>AOF缓冲会根据AOF缓冲区同步文件的三种写回策略将命令写入磁盘上的AOF文件。 </li>
<li>随着写入AOF内容的增加为避免文件膨胀，会根据规则进行命令的合并（又称AOF重写）,从而起到AOF文件压缩的目的。</li>
</ul>
<h3 id="三种写回策略"><a href="#三种写回策略" class="headerlink" title="三种写回策略"></a>三种写回策略</h3><ol>
<li><p><strong>Always</strong> ：同步写回，每个写命令执行完立刻同步地将日志写回磁盘</p>
</li>
<li><p><strong>everysec</strong> ：每秒写回，每个写命令执行完，只是先把日志写到AOF文件的内存缓冲区，每隔1秒把缓冲区中的内容写入磁盘（默认）</p>
</li>
<li><p><strong>no</strong> ：写入aof文件，不等待磁盘同步</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720093202694.png" alt="image-20230720093202694" style="zoom: 50%;" /></li>
</ol>
<table>
<thead>
<tr>
<th>配置项</th>
<th>写回时机</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>Always</td>
<td>同步写回</td>
<td>可靠性高，数据基本不丢失</td>
<td>每个写命令都要落盘，性能影响大</td>
</tr>
<tr>
<td>Everysec</td>
<td>每秒写回</td>
<td>性能适中</td>
<td>宕机时丢失1秒内的数据</td>
</tr>
<tr>
<td>No</td>
<td>操作系统控制的写回</td>
<td>性能好</td>
<td>宕机时丢失数据较多</td>
</tr>
</tbody></table>
<h3 id="文件保存说明"><a href="#文件保存说明" class="headerlink" title="文件保存说明"></a>文件保存说明</h3><h4 id="Multi-part-AOF"><a href="#Multi-part-AOF" class="headerlink" title="Multi-part AOF"></a>Multi-part AOF</h4> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720094517427.png" alt="image-20230720094517427" style="zoom: 50%;" />

<h4 id="开启-appendonly-yes"><a href="#开启-appendonly-yes" class="headerlink" title="开启 appendonly yes"></a>开启 appendonly yes</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720094855849.png" alt="image-20230720094855849"></p>
<h4 id="aof文件-保存路径"><a href="#aof文件-保存路径" class="headerlink" title="aof文件-保存路径"></a>aof文件-保存路径</h4><p><strong>redis6</strong></p>
<p>AOF保存文件的位置和RDB保存文件的位置一样， 都是通过redis.conf配置文件的dir配置</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720095055936.png" alt="image-20230720095055936" style="zoom: 50%;" /> 

<p>RDB文件保存位置：<code>/myredis/dump.rdb</code> </p>
<p>AOF文件保存位置：<code>/myredis/appendonly.aof</code> </p>
<p><strong>reids7</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720095146319.png" alt="image-20230720095146319"></p>
<p>RDB文件保存位置：<code>/myredis/dump.rdb</code></p>
<p>AOF文件保存位置：<code>myredis/appendonlydir/xxx.aof</code></p>
<p><strong>总结</strong></p>
<p>现在设置为 <code>dir /myredis</code> ，表示如果是redis6，继续实行 <code>/myredis/xxx</code> ，</p>
<p>如果是redis7，则实施<code>appendirname &quot;appendonlydir&quot;</code>   ，即 <code>dir + appenddirname</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720095631735.png" alt="image-20230720095631735"></p>
<h4 id="aof文件-保存名称"><a href="#aof文件-保存名称" class="headerlink" title="aof文件-保存名称"></a>aof文件-保存名称</h4><p><strong>redis6</strong> ：有且只有一个</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720095950853.png" alt="image-20230720095950853"></p>
<p><strong>redis7</strong>：Multi Part AOF 的设计</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720100338560.png" alt="image-20230720100338560"></p>
<ul>
<li>base 基本文件<ul>
<li>表示基础AOF,它一般由子进程通过重写产生，该文件最多只有一个。</li>
</ul>
</li>
<li>incr 增量文件<ul>
<li>表示增量AOF,它一般会在AOFRW开始执行时被创建，该文件可能存在多个。（写操作会写入这个文件）</li>
</ul>
</li>
<li>manifest 清单文件<ul>
<li>表示历史AOF,它由BASE和INCR AOF变化而来，每次AOFRW成功完成时，本次AOFRW之前对应 的BASE和INCR AOF都将变为HISTORY,HISTORY类型的AOF会被Redis自动删除。</li>
</ul>
</li>
</ul>
<p><font color='red'><strong>redis7注意：</strong></font></p>
<p>为了管理这些AOF文件，我们引入了一个 manifest(清单）文件来跟踪、管理这些AOF。同时，为了便于AOF备份 和拷贝，我们将所有的AOF文件和 manifest 文件放入一个单独的文件目录中，目录名由appenddirname配置</p>
<p><strong>redis7配置项：</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720100523052.png" alt="image-20230720100523052" style="zoom:50%;" /> 

<h3 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h3><h4 id="正常恢复"><a href="#正常恢复" class="headerlink" title="正常恢复"></a>正常恢复</h4><ul>
<li>将 appendonly 设置为 <code>appendonly yes</code> </li>
<li>生成 AOF 文件到指定目录</li>
</ul>
<p><strong>恢复一：</strong>当重启 redis 重新加载的时候用的是 appendonlydir 文件</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720102450401.png" alt="image-20230720102450401" style="zoom:50%;" /> 

<p><strong>恢复二：</strong> </p>
<ol>
<li><p>写入数据进 redis，然后 <code>flushdb + shutdown 服务器</code> </p>
</li>
<li><p>新生成了 dump 和 aof</p>
</li>
<li><p>备份新生成的 .aof 为 .aof.bak ，然后删除 dump&#x2F;aof 再看恢复</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310204747742.png" alt="image-20230310204747742" style="zoom:50%;" /> 
</li>
<li><p>重启 redis 重新加载，发现数据库为空</p>
</li>
<li><p>停止服务器 ，将 .aof.bak 修改为 .aof 之后在重新启动服务器，发现数据恢复了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230310204820165.png" alt="image-20230310204820165"></p>
<p>表示，数据存储在 .aof 文件中</p>
</li>
</ol>
<h4 id="异常恢复"><a href="#异常恢复" class="headerlink" title="异常恢复"></a>异常恢复</h4><ul>
<li><p>故意乱写正常的 AOF 写入文件（<code>appendonly.aof.1.incr.aof</code>），模拟网络闪断文件写 error </p>
</li>
<li><p>重启 redis 之后就会进入 AOF 文件的载入，发现启动都不行 </p>
</li>
<li><p>异常修复命令 ： <code>redis-check-aof --fix</code> 进行修复 </p>
<p><code>redis-check-aof --fix appendonly.aof.1.incr.aof</code> </p>
</li>
<li><p>重新 OK</p>
</li>
</ul>
<h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><ul>
<li>使用AOF Redis更加持久：您可以有不同的fsync策略：根本不fsync、每秒fsync、每次查询时fsync。使用每秒fsync的默认策略，写入性能仍然很棒。fsync是使用后台线程执行的，当没有fsync正在进行时，主线程将努力执行写入，因此您只能丢失一秒钟的写入。</li>
<li>AOF 日志是一个仅附加日志，因此不会出现寻道问题，也不会在断电时出现损坏问题。即使由于某种原因（磁盘已满或其他原因）日志以写一半的命令结尾，redis-check-aof工具也能够轻松修复它。</li>
<li>当AOF变得太大时，Redis能够在后台自动重写AOF。重写是完全安全的，因为当Redis继续附加到旧文件时，会使用创建当前数据集所需的最少操作集生成一个全新的文件，一旦第二个文件准备就绪，Redis就会切换两者并开始附加到新的那一个。</li>
<li>AOF以易于理解和解析的格式依次包含所有操作的日志。您甚至可以轻松导出AOF文件。例如，即使您不小心使用该FLUSHALL命令刷新了所有内容，只要在此期间没有执行日志重写，您仍然可以通过停止服务器、删除最新命令并重新启动Redis来保存您的数据集</li>
</ul>
<h4 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h4><ul>
<li>相同数据集的数据而言，aof文件要远大于 rdb 文件，恢复速度慢于 rdb</li>
<li>aof 运行效率要慢于 rdb,每秒的同步策略效率较好，不同步效率和 rdb 相同</li>
</ul>
<h3 id="AOF重写机制"><a href="#AOF重写机制" class="headerlink" title="AOF重写机制"></a>AOF重写机制</h3><p>由于AOF持久化是Redis不断将<strong>写命令</strong>记录到AOF文件中，随着Redis不断的进行，AOF的文件会越来越大， 文件越大，占用服务器内存越大以及AOF恢复要求时间会越长。 为了解决这个问题，Redis新增了重写机制，</p>
<ol>
<li>当AOF文件的大小超过所设定的峰值时，Redis就会自动启动AOF文件的内容压缩， 只保留可以恢复数据的最小指令集 </li>
<li>或者 可以手动使用命令 bgrewriteaof来重写。</li>
</ol>
<p><strong>总结：</strong> 启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集</p>
<p><strong>触发自动重写机制的条件：</strong></p>
<ol>
<li><code>auto- aof- rewrite- percentage 100</code> ：根据上次重写后的 aof 大小，判断当前 aof 大小是不是增长了 1 倍（100%）</li>
<li><code>auto- aof- rewrite- min- size 64mb</code> ：重写时满足文件的大小（64mb）</li>
</ol>
<p><font color='red'><strong>注意：</strong></font> 两者同时满足才会触发</p>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><p><strong>需求说明：</strong></p>
<pre class="line-numbers language-例子" data-language="例子"><code class="language-例子">一开始 :  set k1 v1
然后改为: set k2 v2
最后改为: set k3 v3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>开启重写机制后，只保存 <code>set k3 v3</code> 这一条即可，相当于给 aof 文件瘦身减肥，性能更好。</p>
<p>AOF重写不仅降低了文件的占用空间，同时更小的 AOF 也可以更快地被 Redis 加载。</p>
<p><strong>前期配置：</strong></p>
<ul>
<li><p>appendonly 改为 <code>appendonly yes</code> ，默认是 no 关闭，设置为yes就打开 aof 持久化支持</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720143414916.png" alt="image-20230720143414916" style="zoom: 67%;" /></li>
</ul>
<ul>
<li><p>重写峰值改为 1k</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720143637643.png" alt="image-20230720143637643"> </p>
</li>
<li><p>关闭混合，设置为 no （默认为yes，改为no）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720143947856.png" alt="image-20230720143947856"> </p>
</li>
<li><p>删除之前的全部 aof 和 rdb，清除干扰项</p>
</li>
</ul>
<p><strong>自动触发重写：</strong></p>
<ul>
<li>完成上述正确配置，重启redis服务器，执行 <code>set k1 v1</code> 查看 aof 文件是否正常</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230311114557100.png" alt="image-20230311114557100" style="zoom:50%;" /> 

<ul>
<li><p>查看 三大配置文件</p>
<p><strong>配置项</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230311114659669.png" alt="image-20230311114659669" style="zoom:67%;" /> 
</li>
<li><p>k1一直写入 数据1111111，最后触发重写机制</p>
</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720151544925.png" alt="image-20230720151544925" style="zoom: 50%;" /> 

<p><strong>手动触发重传</strong></p>
<p>客户端向服务器发送 <code>bgrewriteaof</code> 命令</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720151739265.png" alt="image-20230720151739265"></p>
<p><strong>结论：</strong></p>
<p>也就是说AOF文件重写并不是对原文件进行重新整理，而是直接读取服务器现有的键值对，然后用一条命令去代替之前记录这个 键值对的多条命令，生成一个新的文件后去替换原来的AOF文件。 </p>
<p>AOF文件重写触发机制：通过redis.conf配置文件中的auto-aof-rewrite-percentage：默认值为100，以及auto-aof-rewrite- min-size:64mb配置，也就是说默认Redis会记录上次重写时的AOF大小，默认配置是当AOF文件大小是上次rewrite后大小的一倍 且 文件大于64M时触发。</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>1：在重写开始前，redis会创建一个“重写子进程”，这个子进程会读取现有的AOF文件，并将其包含的指令进行分析压缩并写入到一个临时文 件中。</p>
<p> 2：与此同时，主进程会将新接收到的写指令一边累积到内存缓冲区中，一边继续写入到原有的AOF文件中，这样做是保证原有的AOF文件的可 用性，避免在重写过程中出现意外。 </p>
<p>3：当“重写子进程”完成重写工作后，它会给父进程发一个信号，父进程收到信号后就会将内存中缓存的写指令追加到新AOF文件中 </p>
<p>4：当追加结束后，redis就会用新AOF文件来代替旧AOF文件，之后再有新的写指令，就都会追加到新的AOF文件中 </p>
<p>5：重写aof文件的操作，并没有读取旧的aof文件，而是将整个内存中的数据库内容用命令的方式重写了一个新的aof文件，这点和快照有点类似</p>
<h4 id="AOF-优化配置详解"><a href="#AOF-优化配置详解" class="headerlink" title="AOF 优化配置详解"></a>AOF 优化配置详解</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230311115731747.png" alt="image-20230311115731747"></p>
<p>大部分默认即可</p>
<h3 id="AOF总结"><a href="#AOF总结" class="headerlink" title="AOF总结"></a>AOF总结</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720153440857.png" alt="image-20230720153440857" style="zoom:50%;" />

<h2 id="RDB-AOF混合持久化"><a href="#RDB-AOF混合持久化" class="headerlink" title="RDB+AOF混合持久化"></a>RDB+AOF混合持久化</h2><p>在同时开启 RDB 和 AOF 持久化时，重启时只会加载 AOF 文件，不会加载 RDB 文件</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720153942928.png" alt="image-20230720153942928" style="zoom: 50%;" /> 

<h3 id="同时开启两种持久化方式"><a href="#同时开启两种持久化方式" class="headerlink" title="同时开启两种持久化方式"></a>同时开启两种持久化方式</h3><p>在这种情况下，当redis重启的时候会优先载入AOF文件来恢复原始的数据， 因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整。</p>
<p>RDB的数据不实时，同时使用两者时服务器重启也只会找AOF文件。那要不要只使用AOF呢？ 作者建议不要，因为RDB更适合用于备份数据库（AOF在不断变化不好备份）,留着rdb作为一个万一的手段。</p>
<ul>
<li><p>开启混合方式设置</p>
<p>设置 <code>aof-use-rdb-preamble</code> 的值为 yes，yes表示开启，设置为no表示禁用</p>
</li>
<li><p>DB+ OF的 混合方式   —–&gt;  结论： RDB 镜像做全量持久化， AOF 做增量持久化</p>
<p>先试用 RDB 进行快照存储，然后使用 AOF 持久化记录所有的写操作，当重写策略满足或手动触发重写的时候，将最新的数据存储为新的 RDB 记录。这样的话，重启服务的时候会从 RDB 和 AOF 两部分恢复数据，既保证了数据完整性，又提高了恢复数据的性能。简单来说：混合持久化方式产生的文件一部分是 RDB 格式，一部分是 AOF 格式，—&gt;  AOF 包括了 <strong>RDB头部+AOF混写</strong></p>
</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720155208405.png" alt="image-20230720155208405" style="zoom: 33%;" /> 

<h2 id="纯缓存模式"><a href="#纯缓存模式" class="headerlink" title="纯缓存模式"></a>纯缓存模式</h2><p>同时关闭 RDB + AOF ，专心做服务器，不再进行持久化功能</p>
<ol>
<li><p><code>save &quot;&quot;</code> ：禁用 RDB</p>
<p>禁用 RDB 持久化模式下，我们仍然可以使用命令 save、bgsave 生成 RDB 文件</p>
</li>
<li><p><code>appendonly no</code> ：禁用 AOF</p>
<p>禁用 AOF 持久化模式下，我们仍然可以使用命令 <code>bgrewriteaof</code> 生成 aof 文件</p>
</li>
</ol>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>在一次跟数据库的连接会话当中，所有执行的SQL要么一起成功，要么一起失败。</p>
<p>可以一次执行多个命令，本质是一组命令的集合。一个事务中的 所有命令都会序列化，按顺序地串行化执行而不会被其它命令插入，不许加塞</p>
<p>一个队列中，一次性、顺序性、排他性的执行一系列命令</p>
<h2 id="Redis事务"><a href="#Redis事务" class="headerlink" title="Redis事务"></a>Redis事务</h2><ol>
<li><p>单独的隔离操作</p>
<p>redis的 事务仅仅是保证事务里的操作会被连续独占的执行，redis 命令执行是 单线程架构，在执行完事务内所有指令前是不可能再去同时执行其他客户端的请求的</p>
</li>
<li><p>没有隔离级别的概念</p>
<p>因为 事务提交前任何执行都不会被实际执行，也就不存在 “事务内的查询要看到事务里的更新，在事务外查询不能看到” 这种问题了</p>
</li>
<li><p>不保证原子性</p>
<p>redis的事务 <strong>不保证原子性</strong>，也就是不保证所有的指令同时失败或同时成功，只有决定是否开始执行全部指令的能力，没有执行到一半进行回滚的能力</p>
</li>
<li><p>排他性</p>
<p>redis 会保证一个事务内的命令依次执行，而不会被其他命令插入</p>
</li>
</ol>
<h3 id="常用命令-9"><a href="#常用命令-9" class="headerlink" title="常用命令"></a>常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>discard</td>
<td>取消事务，放弃执行事务块内的所有命令</td>
</tr>
<tr>
<td>exec</td>
<td>执行所有事务块内的命令</td>
</tr>
<tr>
<td>multi</td>
<td>标记一个事务块的开始</td>
</tr>
<tr>
<td>unwatch</td>
<td>取消 WATCH 命令对所有 key 的监视</td>
</tr>
<tr>
<td>watch key [key …]</td>
<td>监视一个（或多个）key，<br />如果在事务执行之前这个（或这些）key被其他命令所改动，那么事务将被打断</td>
</tr>
</tbody></table>
<h3 id="执行情况"><a href="#执行情况" class="headerlink" title="执行情况"></a>执行情况</h3><h4 id="正常执行"><a href="#正常执行" class="headerlink" title="正常执行"></a>正常执行</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720162743002.png" alt="image-20230720162743002"> </p>
<h4 id="放弃事务"><a href="#放弃事务" class="headerlink" title="放弃事务"></a>放弃事务</h4><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720162949726.png" alt="image-20230720162949726" style="zoom:50%;" /> 

<h4 id="全体连坐"><a href="#全体连坐" class="headerlink" title="全体连坐"></a>全体连坐</h4><p> 一条命令出错，全部打回去</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720163302777.png" alt="image-20230720163302777"></p>
<h4 id="冤头债主"><a href="#冤头债主" class="headerlink" title="冤头债主"></a>冤头债主</h4><p>对的命令执行，错的不执行</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720163710027.png" alt="image-20230720163710027" style="zoom: 50%;" />

<h4 id="watch监控"><a href="#watch监控" class="headerlink" title="watch监控"></a>watch监控</h4><p>Redis使用 watch 来提供乐观锁定，类似于 CAS（Check-and-Set）</p>
<p><strong>悲观锁：</strong> （Redis不用）</p>
<p>悲观锁（Pessimistic Lock)，顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都 会上锁，这样别人想拿这个数据就会block直到它拿到锁。</p>
<p><strong>乐观锁：</strong></p>
<p>乐观锁（Optimistic Lock)，顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据。</p>
<p>乐观锁策略：提交版本必须 大于 记录当前版本才能执行更新</p>
<p><strong>CAS：</strong> 乐观锁</p>
<p>watch指令在redis事物中提供了CAS的行为。为了检测被watch的keys在是否有多个clients同时改变引起冲突，这些keys将会被监控。如果至少有一个被监控的key在执行exec命令前被修改，整个事物将会回滚，不执行任何动作，从而保证原子性操作，并且执行exec会得到null的回复。</p>
<p><strong>乐观锁工作机制：</strong> </p>
<p>watch 命令会监视给定的每一个key，当exec时如果监视的任一个key自从调用watch后发生过变化，则整个事务会回滚，不执行任何动作。</p>
<p>注意watch的key是对整个连接有效的，事务也一样。如果连接断开，监视和事务都会被自动清除。当然exec，discard，unwatch命令，及客户端连接关闭都会清除连接中的所有监视。还有，如果watch一个不稳定(有生命周期)的key并且此key自然过期，exec仍然会执行事务队列的指令。</p>
<p><strong>watch正常情况：</strong></p>
<p>初始化 k1 和 balance 两个 key，先监控再开启 multi，保证两个 key 变动在同一个事务内</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720164819512.png" alt="image-20230720164819512" style="zoom:50%;" /> 

<p><strong>watch有加塞篡改</strong></p>
<p>watch命令是一种乐观锁的实现，Redis在修改的时候会检测数据是否被更改，如果更改了，则执行失败，第一个窗口蓝色框第5步执行结果返回为空，也就是相当于是失败。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720165052689.png" alt="image-20230720165052689" style="zoom: 50%;" />

<p><strong>unwatch</strong> ：取消监控</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720165401736.png" alt="image-20230720165401736" style="zoom: 50%;" />

<p><strong>小结</strong>：</p>
<ul>
<li>一旦执行了 exec ，之前加的监控锁都会被取消掉了</li>
<li>当客户端连接丢失的时候（比如退出连接），所有东西都会被取消监视</li>
</ul>
<h1 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>Redis 是一种基于 客户端-服务端模型 以及请求&#x2F;响应协议 的TCP服务。一个请求会遵循以下步骤：</p>
<ol>
<li>客户端向服务端发送命令分四步（发送命令 -&gt; 命令排队 -&gt; 命令执行 -&gt; 返回结果），并监听 Socket 返回，通常以阻塞模式等待服务端响应</li>
<li>服务端处理命令，并将结果返回给客户端。</li>
</ol>
<p>上述两步称为：<strong>Round Trip Time</strong> （简称RTT，数据报往返于两端的时间）</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720170543535.png" alt="image-20230720170543535" style="zoom:50%;" />

<p>如果同时需要执行大量的命令，那么就要等待上一条命令应答后再执行，这中间不仅仅多了RTT(Round Time Trip)，而且还频繁调用系 IO,发送网络请求，同时需要redis调用多次read()和write()系统方法，系统方法会将数据从用户态转移到内核态，这样就会对进程上下 (较大的影响了，性能不太好）</p>
<p><font color='red'><strong>解决：</strong></font></p>
<p>管道（pipeline)可以一次性发送多条命令给服务端，服务端依次处理完完毕后，通过于条响应一次性将结果返回，通过减少客户端与redis的通信次数 来实现降低往返延时时间。pipeline实现的原理是<strong>队列</strong>，先进先出特性就保证数据的顺序性。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720170743809.png" alt="image-20230720170743809" style="zoom:50%;" />

<p>管道 是为了解决RTT往返回时，仅仅是将命令打包一次性发送，对整个 Redis 的执行不造成其他任何影响</p>
<p><strong>一句话：</strong> 批处理命令变种优化措施，类似 Redis 的原生批命令（mget he  mset） </p>
<h2 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h2><p><strong>用管道批量处理命令：</strong></p>
<p>先创建一个文件，文件中写入命令，用 <code>cat 文件名</code> 查看</p>
<pre class="line-numbers language-命令" data-language="命令"><code class="language-命令">reis-server redis.conf
cat cmd.txt | redis-cli -a abc123 --pipe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720172014679.png" alt="image-20230720172014679"></p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p><strong>pipeline与原生批量命令对比</strong></p>
<ul>
<li>原生批量命令是原子性（例如：mset,mget)，pipeline是非原子性 </li>
<li>原生批量命令一次只能执行一种命令，pipeline支持批量执行不同命令 </li>
<li>原生批命令是服务端实现，而pipeline需要服务端与客户端共同完成</li>
</ul>
<p> <strong>pipeline与事务对比</strong></p>
<ul>
<li>事务具有原子性，管道不具有原子性</li>
<li>管道一次性将多条命令发送到服务器，事务是一条一条的发，事务只有在接收到exec命令后才会执行， 管道不会</li>
<li>执行事务时会阻塞其他命令的执行，而执行管道中的命令时不会</li>
</ul>
<p><strong>使用pipeline注意事项</strong></p>
<ul>
<li>pipeline缓冲的指令只是会依次执行，不保证原子性，如果执行中指令发生异常，将会继续执行后续的指令 </li>
<li>使用pipeline组装的命令个数不能太多，不然数据量过大客户端阻塞的时间可能过久，同时服务端此时也被迫回复一个队列答复，占用很多内存</li>
</ul>
<h1 id="Redis发布-x2F-订阅（pub-x2F-sub）"><a href="#Redis发布-x2F-订阅（pub-x2F-sub）" class="headerlink" title="Redis发布&#x2F;订阅（pub&#x2F;sub）"></a>Redis发布&#x2F;订阅（pub&#x2F;sub）</h1><p>了解即可</p>
<h2 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h2><p><strong>定义：</strong> 是一种消息通信模式：发送者（PUBLISH)发送消息，订阅者（SUBSCRIBE)接收消息，可以实现进程间的消息传递</p>
<p><strong>一句话：</strong> Redis可以实现消息中间件MQ的功能，通过发布订阅实现消息的引导和分流。 仅代表我个人，不推荐使用该功能，专业的事情交给专业的中间件处理，redis就做好分布式缓存功能</p>
<p><strong>能干嘛</strong> ：</p>
<p>Redis客户端可以订阅任意数量的频道，类似我们微信关注多个公众号：当有新消息通过 PUBLISH 命令发送给频道 channel1 时</p>
<p><strong>总结：</strong></p>
<p>发布&#x2F;订阅其实是一个轻量的队列，只不过数据不会被持久化，一般用来处理 实时性较高的异步消息</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720190803170.png" alt="image-20230720190803170" style="zoom:50%;" />



<h2 id="常用命令-10"><a href="#常用命令-10" class="headerlink" title="常用命令"></a>常用命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>PSUBSCRIBE pattern [pattern]</td>
<td>订阅一个或多个符合给定模式的频道</td>
</tr>
<tr>
<td>PUBSUB subcommand [argument [argument…]]</td>
<td>查看订阅与发布系统状态</td>
</tr>
<tr>
<td>PUBLISH channel message</td>
<td>将信息发送到指定的频道</td>
</tr>
<tr>
<td>PUNSUBSCRIBE [pattern [pattern…]]</td>
<td>退订所有给定模式的频道</td>
</tr>
<tr>
<td>SUBSCRIBE channel [channel…]</td>
<td>订阅给定的一个或多个频道的信息</td>
</tr>
<tr>
<td>UNSUBSCRIBE [channel [channel…]]</td>
<td>指退订给定的频道</td>
</tr>
</tbody></table>
<ul>
<li><p><code>PSUBSCRIBE pattern [pattern]</code> ：订阅给定的一个或多个频道的信息</p>
<p>推荐先执行订阅后再发布，订阅成功之前发布的消息是收不到的</p>
<p>订阅的客户端每次可以收到一个 3 个参数的消息</p>
<ul>
<li><p>消息的种类</p>
</li>
<li><p>始发频道的名称</p>
</li>
<li><p>实际的消息内容</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720191528651.png" alt="image-20230720191528651" style="zoom:33%;" /></li>
</ul>
</li>
<li><p><code>publish channel message</code> ：发布信息到指定频道</p>
</li>
<li><p><code>PUBSUB subcommand [argument [argument...]]</code> ：安照模式批量订阅，订阅一个或多个符合给定模式（支持*号 ？号之类的）的频道</p>
<ul>
<li><p><code>PUBSUB channels</code> ：由活跃频道组成的列表</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720191812637.png" alt="image-20230720191812637" style="zoom:33%;" /> 
</li>
<li><p><code>PUBSUB NUMSUB [channel [channel ...]]</code> ：某个频道有几个订阅者</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720191855302.png" alt="image-20230720191855302" style="zoom:33%;" /> 
</li>
<li><p><code>PUBSUB NUMPAT</code> ：只统计使用 PSUBSCRIBE 命令执行的，返回客户端订阅的唯一模式的数量</p>
</li>
</ul>
</li>
</ul>
<p><strong>案例：</strong></p>
<ul>
<li><p>只统计使用 PSUBSCRIBE 命令执行的，返回客户端订阅的唯一 模式的数量</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720192314848.png" alt="image-20230720192314848"></p>
</li>
<li><p>取消订阅</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230720192403996.png" alt="image-20230720192403996"></p>
</li>
</ul>
<h2 id="Pub-x2F-Sub缺点"><a href="#Pub-x2F-Sub缺点" class="headerlink" title="Pub&#x2F;Sub缺点"></a>Pub&#x2F;Sub缺点</h2><ol>
<li>发布的消息在Redis系统中不能持久化，因此，必须先执行订阅，再等待消息发布。如果先发布了消息，那么该消息由于没有订阅者，消息将直接被丢弃</li>
<li>消息只管发送对应发布者而言 消息是即发即失的，不管接收，也没有 ack 机制，无法保证消息的消费成功</li>
<li>以上的缺点导致 redis 的 pub&#x2F;sub 就是像是个 小玩具，在生产环境中几乎无任何用武之地，为此 redis 5.0 版本新增了 stream 数据结构，不但支持多播，还支持数据持久化，相比 pub&#x2F;sub 更加强大</li>
</ol>
<h1 id="Redis复制（replica）"><a href="#Redis复制（replica）" class="headerlink" title="Redis复制（replica）"></a>Redis复制（replica）</h1><h2 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230311155500746.png" alt="image-20230311155500746" style="zoom:33%;" /> 

<ul>
<li><p>主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master)，后者称为从节点(slave)；</p>
</li>
<li><p>数据的复制是单向的，只能由主节点到从节点。</p>
</li>
<li><p>默认情况下，每台Redis服务器都是主节点，且一个主节点可以有多个从节点（或没有从节点），但一个从节点只能有一个主节点。</p>
</li>
<li><p>当 master 数据变化时，自动将新的数据异步同步到其他的 slave 数据库</p>
</li>
<li><p>有了主从，当 master 挂掉的时候，运维让从库过来接管，服务就可以继续，否则 master 需要经过数据恢复和重启的过程，这就可能会拖很长的时间，影响线上业务的持续服务。</p>
</li>
</ul>
<p><font color='red'><strong>主从复制的作用</strong></font></p>
<ul>
<li><strong>数据冗余</strong>：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。</li>
<li><strong>故障恢复</strong>：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。</li>
<li><strong>负载均衡</strong>：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连接主节点，读Redis数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。</li>
<li><strong>高可用基石</strong>：主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。</li>
</ul>
<p><font color='red'><strong>权限细节</strong></font></p>
<p>master 如果配置了 requirepass 参数，需要密码登录</p>
<p>那么 slave 就要配置 masterauth 来设置校验密码，否则的话 master 会拒绝 slave 的访问请求</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721150413254.png" alt="image-20230721150413254"></p>
<h2 id="常用命令-11"><a href="#常用命令-11" class="headerlink" title="常用命令"></a>常用命令</h2><ul>
<li><code>info replication</code><ul>
<li>建立连接关系后，可以查看复制节点的主从关系和配置信息</li>
</ul>
</li>
<li><code>replicaof 主库IP 主库端口</code>   （用配置文件操作）<ul>
<li>一般写入进 redis.conf 配置文件内</li>
</ul>
</li>
<li><code>slaveof 主库IP 主库端口</code>   （用命令操作。）<ul>
<li>每次与 master 断开之后，都需要重新连接，除非你配置进 redis.conf 文件</li>
<li>在运行期间修改 slave 节点的信息，如果该数据库已经是某个主数据库的从数据库，那么会停止和原数据库的同步关系 转而和新的主数据库同步，重新拜码头。</li>
</ul>
</li>
<li><code>slaveof no one</code> <ul>
<li>使当前数据库停止与其他数据库的同步，转成主数据库，自立为王</li>
</ul>
</li>
</ul>
<h2 id="案例-2"><a href="#案例-2" class="headerlink" title="案例"></a>案例</h2><p>创建三个虚拟机，一个master两个slave</p>
<p>每台都安装redis，拷贝多个 redis.conf 文件，<code>redis6379.conf</code> 、<code>redis6380.conf</code>、<code>redis6381.conf</code> </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721152345946.png" alt="image-20230721152345946" style="zoom: 50%;" />

<p><strong>小口诀：</strong></p>
<ul>
<li>三边网络相互ping通 且注意防火墙配置</li>
</ul>
<p><strong>三大命令：</strong></p>
<ul>
<li>主从复制<ul>
<li><code>replicaof 主库IP 主库端口</code></li>
<li>配从（库）不配主（库）</li>
</ul>
</li>
<li>改换门庭<ul>
<li><code>replicaof 新主库IP 新主库端口</code></li>
</ul>
</li>
<li>自立为王<ul>
<li><code>slaveof no one</code></li>
</ul>
</li>
</ul>
<h3 id="操作细节"><a href="#操作细节" class="headerlink" title="操作细节"></a>操作细节</h3><ol>
<li><p>开启 <code>daemonize yes</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721153350536.png" alt="image-20230721153350536"></p>
</li>
<li><p>注释掉 <code>bind 127.0.0.1</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721153409328.png" alt="image-20230721153409328"></p>
</li>
<li><p><code>protected-mode no</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721153431030.png" alt="image-20230721153431030"></p>
</li>
<li><p>指定端口</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721153528662.png" alt="image-20230721153528662"></p>
</li>
<li><p>指定当前工作目录，dir</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721153552906.png" alt="image-20230721153552906"></p>
</li>
<li><p>pid 文件名字，pidfile</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721153618383.png" alt="image-20230721153618383"></p>
</li>
<li><p>log 文件名字，logfile</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721153657742.png" alt="image-20230721153657742"></p>
</li>
<li><p>requirepass  设置密码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721153736947.png" alt="image-20230721153736947"></p>
</li>
<li><p>dump.rdb 名字</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721153754504.png" alt="image-20230721153754504" style="zoom: 50%;" /> 
</li>
<li><p>aof文件，appendfilename   （非必须）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721153839374.png" alt="image-20230721153839374"></p>
</li>
<li><p>从机访问主机的通行密码 masterauth，必须  （<strong>从机需要配置，主机不用</strong>）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721154217008.png" alt="image-20230721154217008"></p>
</li>
</ol>
<h3 id="一主二仆"><a href="#一主二仆" class="headerlink" title="一主二仆"></a>一主二仆</h3><h4 id="方案1：配置文件固定写死"><a href="#方案1：配置文件固定写死" class="headerlink" title="方案1：配置文件固定写死"></a>方案1：配置文件固定写死</h4><ul>
<li><p>配置文件执行：<code>replicaof 主库IP 主库端口</code> </p>
</li>
<li><p>配从（库）不配主（库）：</p>
<ul>
<li><p>配置从机 6380</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230311202003826.png" alt="image-20230311202003826"></p>
</li>
<li><p>配置从机6381</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230311202020172.png" alt="image-20230311202020172"></p>
</li>
</ul>
</li>
<li><p>先 master 后两台 slave 依次启动  （注意从机的 <code>redis-cli -a 111111 -p 6380</code>） 其中必须要写 <code>-p 6380</code></p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721154608952.png" alt="image-20230721154608952"></p>
<ul>
<li><p>查看主从关系（主机日志）   <code>vim 6379.log</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230311202708291.png" alt="image-20230311202708291"></p>
</li>
<li><p>备机日志 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230311202743095.png" alt="image-20230311202743095"></p>
</li>
<li><p>使用 <code>info replication</code> 命令查看</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721155402368.png" alt="image-20230721155402368" style="zoom:50%;" /></li>
</ul>
<p><font color='red'><strong>注意：</strong></font>如果从机连接不到主机，可以关闭防火墙，重启服务</p>
<ul>
<li><p>首先修改 redis.conf 中的相关配置 </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230722153256101.png" alt="image-20230722153256101" style="zoom: 50%;" /> 
</li>
<li><p>关闭主机的防火墙 <code>systemctl stop firewalld</code></p>
</li>
<li><p>关闭 redis 服务</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230722153402041.png" alt="image-20230722153402041" style="zoom:50%;" /></li>
</ul>
<p><strong>主从问题演示：</strong></p>
<ul>
<li><p>从机可以执行写命令</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230311203234915.png" alt="image-20230311203234915" style="zoom:50%;" /> 
</li>
<li><p>从机切入点问题</p>
<p>从机宕机后，主机继续写入，当从机恢复过来了也可以读取到主机写入的，master写，slave跟</p>
</li>
<li><p>主机 shutdown 后，从机会上位吗？</p>
<p>当主机 shutdown 后，从机会原地待命，从机数据还可以正常使用，这时候在等待主机恢复。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230311203934135.png" alt="image-20230311203934135" style="zoom:50%;" /> 

<p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721160324338.png" alt="image-20230721160324338"></p>
</li>
<li><p>主机 shutdown 后，重启后主从关系还在吗？从机还能顺利复制吗？</p>
<p>主从关系还在</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721160516298.png" alt="image-20230721160516298" style="zoom:67%;" /></li>
</ul>
<h4 id="方案2：命令操作手动指定"><a href="#方案2：命令操作手动指定" class="headerlink" title="方案2：命令操作手动指定"></a>方案2：命令操作手动指定</h4><ul>
<li><p>从机 停机去掉配置文件中的配置项，3台目前都是主机状态，各不从属</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721160812187.png" alt="image-20230721160812187" style="zoom:50%;" /></li>
</ul>
<p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721161323561.png" alt="image-20230721161323561"></p>
<ul>
<li><p>预设的从机上执行命令  <code>slaveof 主库IP 主库端口</code> </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721161451739.png" alt="image-20230721161451739" style="zoom: 50%;" /></li>
</ul>
<p><font color='red'><strong>注意：</strong></font></p>
<p>用命令使用的话，2台从机重启后，主从关系不存在了，说明名命令使用的话只是单次生效的，想要永久是主从关系的话，还是得用配置文件固定写死他们之间的主从关系。</p>
<h3 id="薪火相传"><a href="#薪火相传" class="headerlink" title="薪火相传"></a>薪火相传</h3><ul>
<li><p>上一个 slave 可以是下一个 slave 的 master，slave 同样可以接收其他 slaves 的连接和同步请求，那么该 slave 作为了链条中的下一个的master，可以有效减轻 主master 的写压力</p>
</li>
<li><p>中途变更转向：会清除之前的数据，重新建立拷贝最新的</p>
</li>
<li><p><code>slaveof 新主库IP 新主库端口</code></p>
</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721162544178.png" alt="image-20230721162544178" style="zoom:50%;" />

<p>在 6381 redis下，<code>slaveof 192.168.111.172 6380</code>  ，将6381的老大换成 6380</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721164234184.png" alt="image-20230721164234184" style="zoom:50%;" /> 

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721164333765.png" alt="image-20230721164333765" style="zoom:50%;" /> 

<h3 id="反客为主"><a href="#反客为主" class="headerlink" title="反客为主"></a>反客为主</h3><p><code>slaveof no one</code> ：使用当当前数据库停止与其他数据库</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721164546217.png" alt="image-20230721164546217" style="zoom:50%;" /> 

<h2 id="复制原理和工作流程"><a href="#复制原理和工作流程" class="headerlink" title="复制原理和工作流程"></a>复制原理和工作流程</h2><ul>
<li>slave 启动，同步初请<ul>
<li>slave 启动成功连接到 master 后会发送一个 sync 命令</li>
<li>slave 首次全新连接 master，一次完全同步（全量复制）将被自动执行，slave 自身原有数据会被 master数据覆盖清除</li>
</ul>
</li>
<li>首次连接，全量复制<ul>
<li>master节点收到sync命令后会开始在后台保存快照（即RDB持久化，主从复制时会触发RDB)，同时收集所有接收到的用于修改数据集命令缓存起来，master节点执行RDB持久化完后， master将rdb快照文件和所有缓存的命令发送到所有slave，以完成一次完全同步</li>
<li>slave服务在接收到数据库文件数据后，将其存盘并加载到内存中，从而完成复制初始化</li>
</ul>
</li>
<li>心跳持续，保持通信<ul>
<li><code>repl-ping-replica-period 10</code>  ：10秒保持一次通信</li>
</ul>
</li>
<li>进入平稳，增量复制<ul>
<li>master 继续将新的所有收集到的修改命令自动依次传给 slave，完成同步</li>
</ul>
</li>
<li>从机下线，重连续传<ul>
<li>master 会检查 backlog 里面的 offset，master 和 slave 都会保存一个复制的 offset 还有一个 masterId，offset 是保存在 backlog 中的。<font color='red'>master 只会把已经复制的 offset 后面的数据复制给 slave</font>，类似断点续传</li>
</ul>
</li>
</ul>
<h2 id="复制的缺点"><a href="#复制的缺点" class="headerlink" title="复制的缺点"></a>复制的缺点</h2><ul>
<li><p>复制延时，信号衰减</p>
<p>由于所有的写操作都是先在 master 上操作，然后同步更新到 slave 上，所以从 master 同步到 slave 机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，slave机器数量的增加也会使这个文件更加严重。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721170600478.png" alt="image-20230721170600478" style="zoom:50%;" /> 
</li>
<li><p>master 挂了怎么办</p>
<p>主机shutdown了，从机不懂，原地待命，从机数据可以正常使用，等待主机重启。</p>
<ul>
<li>默认情况下，不会在 slave 节点中自动重选一个 master</li>
<li>此时，每次都要人工干预</li>
</ul>
</li>
</ul>
<h1 id="Redis哨兵（sentinel）"><a href="#Redis哨兵（sentinel）" class="headerlink" title="Redis哨兵（sentinel）"></a>Redis哨兵（sentinel）</h1><h2 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h2><p>吹哨人巡查监控后台master主机是否故障，如果故障了根据投票数自动 将某一个从库转换为新主库，继续对外服务</p>
<p><strong>作用：</strong> 俗称，无人值守运维</p>
<ol>
<li><p>监控 redis 运行状态，包括 master 和 slave</p>
</li>
<li><p>当 master 宕机，能自动将 slave 切换成新的 master</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230721171524083.png" alt="image-20230721171524083" style="zoom:50%;" /></li>
</ol>
<p><strong>能干嘛：</strong></p>
<ul>
<li>主从监控<ul>
<li>监控主从 redis 库运行是否正常</li>
</ul>
</li>
<li>消息通知<ul>
<li>哨兵可以将故障转移的结果发送给客户端</li>
</ul>
</li>
<li>故障转移<ul>
<li>如果 master 异常，则会进行主从切换，将其中一个 slave 作为新的 master</li>
</ul>
</li>
<li>配置中心，客户端通过连接哨兵来获得当前 redis 服务的主节点地址</li>
</ul>
<p><strong>前提说明</strong></p>
<ul>
<li><p>3个哨兵</p>
<p>自动监控和维护集群，不存放数据，只是吹哨人</p>
</li>
<li><p>一主二从</p>
<p>用于数据读取和存放</p>
</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230722090827547.png" alt="image-20230722090827547" style="zoom: 50%;" /> 

<h2 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h2><h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><ul>
<li><p>&#x2F;myredis 目录下新建或者拷贝 sentinel.conf 文件，名字不能错</p>
<ul>
<li><code>cp sentinel.conf /myredis/</code></li>
</ul>
</li>
<li><p>先看看 &#x2F;opt 目录下默认的 sentinel.conf 文件的内容</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230722091057561.png" alt="image-20230722091057561" style="zoom:50%;" /> 
</li>
<li><p>使用 <code>vim sentinel.conf</code> 进入vim界面，重点参数说明</p>
<ul>
<li><p><code>bind</code> ：服务监听地址，用于客户端连接，默认本机地址</p>
</li>
<li><p><code>daemonize</code> ：是否以后台 daemon 方式运行</p>
</li>
<li><p><code>protected-mode</code> ：安全保护模式</p>
</li>
<li><p><code>port</code> ：端口</p>
</li>
<li><p><code>logfile</code> ：日志文件路径</p>
</li>
<li><p><code>pidfile</code> ：pid 文件路径</p>
</li>
<li><p><code>dir</code> ：工作目录</p>
</li>
<li><p><code>sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</code> ：其中quorum表示投票数</p>
<ul>
<li>设置要监控的 master 服务器</li>
<li>quorum 表示最少有几个哨兵认可客观下线，同意故障迁移的法定票数</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230722093855380.png" alt="image-20230722093855380"></p>
</li>
</ul>
<blockquote>
<p>我们知道，网络是不可靠的，有时候一个sentinel会因为网络堵塞而误以为一个master redis已经死掉了，在 sentinel集群环境下需要多个sentinel互相沟通来确认某个master是否真的死了，quorum这个参数是进行客观 下线的一个依据，意思是至少有quorum个sentinel认为这个master有故障，才会对这个master进行下线以及 故障转移。因为有的时候，某个sentinel节点可能因为自身网络原因，导致无法连接master，而此时master并 没有出现故障，所以，这就需要多个sentinel都一致认为该master有问题，才可以进行下一步操作，这就保证 了公平性和高可用。</p>
</blockquote>
<ul>
<li><code>sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</code> ：master设置了密码，连接master服务的密码</li>
</ul>
</li>
<li><p>其他参数说明</p>
<ul>
<li><p><code>sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</code> ：</p>
<p>指定多少毫秒之后，主节点没有应答哨兵，此时哨兵主观上认为主节点下线</p>
</li>
<li><p><code>sentinel parallel-syncs &lt;master-name&gt; &lt;nums&gt;</code> ：</p>
<p>表示允许并行同步的slave个数，当Master挂了后，哨兵会选出新的Master,此时，剩余的slave会向新的master发起同步数据</p>
</li>
<li><p><code>sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</code> :</p>
<p>故障转移的超时时间，进行故障转移时，如果超过设置的毫秒，表示故障转移失败</p>
</li>
<li><p><code>sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</code> ：</p>
<p>配置当某一事件发生时所需要执行的脚本</p>
</li>
<li><p><code>sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</code> </p>
<p>客户端重新配置主节点参数脚本</p>
</li>
</ul>
</li>
</ul>
<p><strong>哨兵 sentinel 文件通用配置</strong></p>
<p>这里是在IP为192.168.200.129这台虚拟机中配置的三份sentinel</p>
<ul>
<li><p>sentinel26379.conf</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">bind 0.0.0.0
daemonize yes
protected-mode no
port 26379
logfile "/myredis/sentinel26379.log"
pidfile /var/run/redis-sentinel26379.pid
dir /myredis
sentinel monitor mymaster 192.168.200.129 6379 2
sentinel auth-pass mymaster abc123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>sentinel26380.conf</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">bind 0.0.0.0
daemonize yes
protected-mode no
port 26380
logfile "/myredis/sentinel26380.log"
pidfile /var/run/redis-sentinel26380.pid
dir /myredis
sentinel monitor mymaster 192.168.200.129 6379 2
sentinel auth-pass mymaster abc123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>sentinel26381.conf</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">bind 0.0.0.0
daemonize yes
protected-mode no
port 26381
logfile "/myredis/sentinel26381.log"
pidfile /var/run/redis-sentinel26381.pid
dir /myredis
sentinel monitor mymaster 192.168.200.129 6379 2
sentinel auth-pass mymaster abc123<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p>master主机配置文件说明：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230722145417539.png" alt="image-20230722145417539"> </p>
<p><strong>先启动 一主二从 3个 redis实例实例，测试正常的主从复制</strong></p>
<ul>
<li><p>架构说明</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312093624411.png" alt="image-20230312093624411" style="zoom:50%;" /> 

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312093637099.png" alt="image-20230312093637099"> </p>
</li>
<li><p>redis 6379 &#x2F; 6380 &#x2F; 6381.conf 内容，填写主从配置</p>
<ul>
<li><p>主机 6379</p>
<p>主机后面可能会变成从机，也需要设置访问密码，设置<code>masterauth &quot;abc123&quot;</code> </p>
<p>不然后续会报错 <code>master_link_status:down</code></p>
</li>
</ul>
</li>
<li><p>三台不同的虚拟机实例，启动三部真实机器示例并连接</p>
<p><code>redis-cli -a abc123 -p 6379</code>  </p>
<p><code>redis-cli -a abc123 -p 6380</code> </p>
<p><code>redis-cli -a abc123 -p 6381</code></p>
</li>
</ul>
<h3 id="哨兵部分"><a href="#哨兵部分" class="headerlink" title="哨兵部分"></a>哨兵部分</h3><ul>
<li><p>在主机6379中启动3个哨兵，完成监控</p>
<pre class="line-numbers language-哨兵，启动！" data-language="哨兵，启动！"><code class="language-哨兵，启动！">redis-sentinel sentinel26379.conf --sentinel
redis-sentinel sentinel26380.conf --sentinel
redis-sentinel sentinel26381.conf --sentinel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动3个哨兵监控后再测试一次主从复制</p>
</li>
<li><p>使原有的 master down 机</p>
<ul>
<li>手动关闭 6379 服务器，模拟 master down 机</li>
</ul>
</li>
<li><p>结果</p>
<ul>
<li>两台从机数据正常</li>
<li>会根据投票数从其他两台从机上选取一个作为master</li>
<li>之前down机的master重启会变为从机</li>
</ul>
</li>
<li><p>问题</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723093245394.png" alt="image-20230723093245394" style="zoom:50%;" /> 
</li>
<li><p>Broken pipe</p>
<ul>
<li><p>pipe 是管道的意思，管道里面是数据流，通常是 从 文件或者 套接字读取的数据。当该管道从另一端突然崩溃关闭时，会发生数据突然中断，即是 broken，对于 socket 来说，可能是网络被拔出或另一端的进程崩溃</p>
</li>
<li><p>解决</p>
<p>其实当该异常产生的时候，对于服务端来说，并没有多少影响。因为可能是某个客户端突然中止了进程导致崩溃导致了该错误</p>
</li>
<li><p>总结</p>
<p>其实当该异常产生的时候，对于服务端来说，并没有多少影响。因为可能是某个客户端突然中止了进程导致崩溃导致了该错误</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312095222544.png" alt="image-20230312095222544"></p>
</li>
</ul>
</li>
<li><p>投票新选</p>
<ul>
<li><p>sentinel26379.log</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312095903020.png" alt="image-20230312095903020"></p>
</li>
<li><p>sentinel26380.log</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312095922085.png" alt="image-20230312095922085"></p>
</li>
<li><p>sentinel26381.log</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312095937279.png" alt="image-20230312095937279"></p>
</li>
<li><p>此时 6381 被选为新的 master，上位成功</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312100046138.png" alt="image-20230312100046138" style="zoom: 50%;" />
</li>
<li><p>以前的 6379 从 master 降级为 slave</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312100130475.png" alt="image-20230312100130475"></p>
</li>
<li><p>6380还是从机，只不过换了个新老大 6381,6380还是 slave</p>
</li>
</ul>
</li>
<li><p>配置文件</p>
<ul>
<li>文件的内容，在运行期间会被 sentinel 动态改变</li>
<li>master - slave 切换后，master_redis.conf 、sentinel.conf 的内容都会发生改变，即 master_redis.conf 中会多一行 slaveof 的配置，sentinel.conf 的监控目标会随之调换</li>
</ul>
</li>
</ul>
<blockquote>
<p>生产都是不同机房，不同服务器，很少出现三个 哨兵全挂掉的情况</p>
<p>可以同时监控多个 master，一行一个</p>
</blockquote>
<h2 id="哨兵原理"><a href="#哨兵原理" class="headerlink" title="哨兵原理"></a>哨兵原理</h2><p>当一个主从配置中的master失效之后，sentinel可以选举出一个新的master 用于自动接替原master的工作，主从配置中的其他redis服务器自动指向新的master同步数据。 一般建议sentinel采取奇数台，防止某一台sentinel无法连接到master导致误切换</p>
<h3 id="运行流程-故障切换"><a href="#运行流程-故障切换" class="headerlink" title="运行流程 故障切换"></a>运行流程 故障切换</h3><ul>
<li><p>三个哨兵监控一主二从，正常运行中</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723100301354.png" alt="image-20230723100301354" style="zoom:33%;" /> 
</li>
<li><p>SDown主观下线（Subjectively Down）</p>
<ul>
<li>SDOWN（主观不可用）是在 <strong>单个sentinel自己主观上</strong>检测到的关于master的状态，从 sentinel 的角度来看，如果发送了Ping后，在一定时间内没有收到合法的回复，就达到了SDOWN的条件。</li>
<li>sentinel 配置文件中的 down-after-millisecond 设置了判断主观下线的时间长度</li>
</ul>
<p><font color='red'><strong>说明：</strong></font></p>
<p>所谓主观下线（Subjectively Down， 简称 SDOWN）指的是<strong>单个Sentinel实例</strong>对服务器做出的下线判断，即单个sentinel认为某个服务下线（有可能是接收不到订阅，之间的网络不通等等原因）。主观下线就是说如果服务器在[sentinel down-after-milliseconds]给定的毫秒数之内没有回应PING命令或者返回一个错误消息， 那么这个Sentinel会主观的（<strong>单方面的</strong>）认为这个master不可以用了</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723100027870.png" alt="image-20230723100027870" style="zoom:50%;" />

<pre class="line-numbers language-none"><code class="language-none">sentinel down-after-milliseconds &lt;masterName&gt; &lt;timeout&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>表示master被当前sentinel实例认定为失效的间隔时间，这个配置其实就是进行主观下线的一个依据</p>
<p>master在多长时间内一直没有给Sentine返回有效信息，则认定该master主观下线。也就是说如果多久没联系上redis-servevr，认为这个redis-server进入到失效（SDOWN）状态。</p>
</li>
<li><p>ODown客观下线（Objectively Down）</p>
<ul>
<li>ODOWN需要一定数量的 sentinel，多个哨兵达成一致意见才能认为一个 master 客观上已经 down 掉</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723100421498.png" alt="image-20230723100421498" style="zoom: 50%;" />

<p><strong>quorum这个参数是进行客观下线的一个依据</strong>，法定人数 &#x2F; 法定票数。</p>
<p>意思是至少有 quorum 个 sentinel 认为这个 master 有故障才会对这个master进行下线以及故障转移。因为有的时候，某个sentinel 节点可能因为自身网络原因导致无法连接master,而此时master并没有出现故障，所以这就需要多个sentinel都一致认为该master有问题，才可以进行下一步操作，这就保证了公平性和高可用。</p>
</li>
<li><p>选举出领导者哨兵（哨兵中选出兵王）</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723100716644.png" alt="image-20230723100716644" style="zoom:50%;" />

<ul>
<li><p>当主节点被判断客观下线以后，各个哨兵节点会进行协商， 先选举出一个领导者哨兵节点（兵王）并由该领导者节	点， 也即被选举出的兵王进行failover(故障迁移）</p>
</li>
<li><p>sentinel26379.log</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312102841293.png" alt="image-20230312102841293"></p>
</li>
<li><p>sentinel26380.log</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312102929005.png" alt="image-20230312102929005"></p>
</li>
<li><p>sentinel26381.log</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312102957390.png" alt="image-20230312102957390"></p>
</li>
<li><p>哨兵领导者，兵王如何选出来的？</p>
<ul>
<li><p>Raft算法</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723101131392.png" alt="image-20230723101131392" style="zoom:50%;" /></li>
</ul>
<p>监视该主节点的所有哨兵都有可能被选为领导者，选举使用的算法是Raft算法；Raft算法的基本思路是先到先得： 即在一轮选举中，哨兵A向B发送成为领导者的申请，如果B没有同意过其他哨兵，则会同意A成为领导者</p>
</li>
</ul>
</li>
<li><p>由兵王开始推动故障切换流程并选出一个新master</p>
</li>
</ul>
<p><strong>新主登基</strong></p>
<ul>
<li><p>某个Slave被选中成为新的master</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723103615524.png" alt="image-20230723103615524" style="zoom:33%;" /> 
</li>
<li><p>选出新master的规则，剩余slave节点健康前提下</p>
<ul>
<li><p>redis.conf 文件中，优先级 slave-priority 或者 replica-priority 最高的从节点（数字越小优先级越高）</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723103735447.png" alt="image-20230723103735447" style="zoom: 50%;" />
</li>
<li><p>复制偏移位置 offset 最大的从节点</p>
</li>
<li><p>最小 Run ID 的从节点  -&gt; 字典顺序，ASCII 码</p>
</li>
</ul>
</li>
</ul>
<p><strong>群臣俯首</strong></p>
<ul>
<li>一朝天子一朝臣，换个码头重新拜</li>
<li>执行slaveof no one命令让选出来的从节点成为新的主节点，并通过slaveof命令让其他节点成为其从节点</li>
<li>Sentinel leader会对选举出的新master执行slaveof no one操作，将其提升为master节点 </li>
<li>Sentinel leader向其它slave发送命令，让剩余的slave成为新的master节点的slave</li>
</ul>
<p><strong>旧主拜服</strong></p>
<ul>
<li>老master回来也认怂</li>
<li>将之前已下线的老master设置为新选出的新master的从节点，当老master重新上线后，它会成为新master的从节点</li>
<li>Sentinel leader会让原来的master降级为slave并恢复正常工作。</li>
</ul>
<p><strong>总结</strong> ：上述的 failover 操作均有 sentinel 自己独自完成，完全无需人工干预</p>
<h2 id="哨兵使用建议"><a href="#哨兵使用建议" class="headerlink" title="哨兵使用建议"></a>哨兵使用建议</h2><ul>
<li>哨兵节点的数量应为多个，哨兵本身应该集群，保证高可用 </li>
<li>哨兵节点的数量应该是奇数 </li>
<li>各个哨兵节点的配置应一致</li>
<li>如果哨兵节点部署在Docker等容器里面，尤其要注意端口的正确映射 </li>
<li>哨兵集群+主从复制，并不能保证数据零丢失</li>
</ul>
<h1 id="Redis集群（cluster）"><a href="#Redis集群（cluster）" class="headerlink" title="Redis集群（cluster）"></a>Redis集群（cluster）</h1><h2 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h2><p><strong>由于数据量过大，单个 master 复制集</strong> 难以承担，因此需要对多个复制集进行集群，形成水平扩展。每个复制集只负责整个数据集的一部分，这就是 redis 集群，其作用就是在 多个 redis节点间 共享数据的程序集</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312110549308.png" alt="image-20230312110549308" style="zoom:50%;" />

<ul>
<li>Redis集群是一个提供在多个 Redis 节点间共享数据的程序集</li>
<li>Redis集群可以支持多个master</li>
</ul>
<p><strong>能干嘛：</strong></p>
<ul>
<li>Redis集群支持多个 master，每个 master 又可以挂载多个 slave<ul>
<li>读写分离</li>
<li>支持数据的高可用</li>
<li>支持海量数据的读写存储操作</li>
</ul>
</li>
<li>由于 Cluster 自带 Sentinel 的故障转移机制，内置了高可用的支持，无需再使用哨兵功能</li>
<li>客户端与 Redis 的节点连接，不再需要连接集群中所有的节点，只需要任意连接集群中的一个可用节点即可</li>
<li>槽位 slot 负责分配到各个物理服务节点，由对应的集群来负责维护节点、插槽和数据之间的关系</li>
</ul>
<h2 id="集群算法-分片-槽位slot"><a href="#集群算法-分片-槽位slot" class="headerlink" title="集群算法-分片-槽位slot"></a>集群算法-分片-槽位slot</h2><p><strong>官网文档：</strong></p>
<p>The cluster’s key space is split into 16384 slots, effectively setting an upper limit for the cluster size of 16384 master nodes (however, the suggested max size of nodes is on the order of ~ 1000 nodes).</p>
<p>Each master node in a cluster handles a subset of the 16384 hash slots. The cluster is <strong>stable</strong> when there is no cluster reconfiguration in progress (i.e. where hash slots are being moved from one node to another). When the cluster is stable, a single hash slot will be served by a single node (however the serving node can have one or more replicas that will replace it in the case of net splits or failures, and that can be used in order to scale read operations where reading stale data is acceptable).</p>
<p>The base algorithm used to map keys to hash slots is the following (read the next paragraph for the hash tag exception to this rule):</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">HASH_SLOT = CRC16(key) mod 16384<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The CRC16 is specified as follows:</p>
<ul>
<li>Name: XMODEM (also known as ZMODEM or CRC-16&#x2F;ACORN)</li>
<li>Width: 16 bit</li>
<li>Poly: 1021 (That is actually x^16 + x^12 + x^5 + 1)</li>
<li>Initialization: 0000</li>
<li>Reflect Input byte: False</li>
<li>Reflect Output CRC: False</li>
<li>Xor constant to output CRC: 0000</li>
<li>Output for “123456789”: 31C3</li>
</ul>
<p>14 out of 16 CRC16 output bits are used (this is why there is a modulo 16384 operation in the formula above).</p>
<p>In our tests CRC16 behaved remarkably well in distributing different kinds of keys evenly across the 16384 slots.</p>
<p><strong>Note</strong>: A reference implementation of the CRC16 algorithm used is available in the Appendix A of this document.</p>
<p>集群的密钥空间被分成16384个插槽，有效地设置了16384个主节点的集群大小上限(但是，建议的最大节点大小大约为1000个节点)。</p>
<p>集群中的每个主节点处理16384个哈希槽的子集。当没有正在进行的群集重新配置时，集群是<strong>稳定的</strong> (即散列片段从一个节点移动到另一个节点)。当集群稳定时，单个哈希槽将由单个节点提供服务(但是，服务节点可以有一个或多个副本，在网络拆分或故障的情况下替换它，并且可以用于在读取陈旧数据是可接受的情况下扩展读取操作)。</p>
<h3 id="槽位slot与分片"><a href="#槽位slot与分片" class="headerlink" title="槽位slot与分片"></a>槽位slot与分片</h3><p><strong>Redis集群的数据分片</strong></p>
<p>Redis 集群投有使用一致性hash，而是引入了<strong>哈希槽</strong>的概念.。</p>
<p>Redis 集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽。集群的每个节点负责一部分hash槽， 举个例子，比如当前集群有3个节点，那么：</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723151526071.png" alt="image-20230723151526071" style="zoom:50%;" />

<ul>
<li><p>分片：</p>
<p>使用Redis集群时我们会将存储的数据分散到多台redis机器上，这称为分片。简言之，集群中的每个Redis实例都被认为是整个数据的一个分片。</p>
</li>
<li><p>如何找到给定key的分片</p>
<p>为了找到给定key的分片，我们对key进行 <strong>CRC16(key)</strong> 算法处理并通过对总分片数量取模。然后，使用确定性哈希函数，这意味着给定的 key 将多次始终映射到同一个分片，我们可以推断将来读取特定 key 的位置</p>
</li>
</ul>
<p><font color='red'><strong>槽位与分片的优势：</strong></font></p>
<p>最大优势：方便扩容和数据分派查找</p>
<p>这种结构很容易添加或者删除节点。比如如果我想新添加个节点D，我需要从节点A,B,C中的部分槽到D上。如果我想移除节点 A，需要将A中的槽移到B和C节点上，然后将没有任何槽的A节点从集群中移除即可。由于从一个节点将哈希槽移动到另一个节点 并不会停止服务，所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态。</p>
<h3 id="slot槽位映射解决方案"><a href="#slot槽位映射解决方案" class="headerlink" title="slot槽位映射解决方案"></a>slot槽位映射解决方案</h3><h4 id="哈希取余分区"><a href="#哈希取余分区" class="headerlink" title="哈希取余分区"></a>哈希取余分区</h4><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723152749559.png" alt="image-20230723152749559" style="zoom:50%;" /> 

<p>2亿条记录就是2亿个k,v，我们单机不行必须要分布式多机，假设有3台机器构成一个集群，用户每次读写操作都是根据公式： <code>hash(key) % N</code> 个机器台数，计算出哈希值，用来决定数据映射到哪一个节点上。</p>
<p><font color='red'><strong>优点：</strong></font></p>
<p>简单粗暴，直接有效，只需要预估好数据规划好节点，例如3台、8台、10台，就能保证一段时间的数据支撑。使用Hash算法让固定的一部分 到同一台服务器上，这样每台服务器固定处理一部分请求（并维护这些请求的信息），起到负载均衡 + 分而治之的作用。</p>
<p><font color='red'><strong>缺点：</strong></font></p>
<p>原来规划好的节点，进行扩容或者缩容就比较麻烦了额，不管扩缩，每次数据变动导致节点有变动，映射关系需要重新进行计算，在服 个数固定不变时没有问题，如果需要弹性扩容或故障停机的情况下，原来的取模公式就会发生变化：Hash(key)&#x2F;3会变成Hash(key)&#x2F;?。此 地址经过取余运算的结果将发生很大变化，根据公式获取的服务器也会变得不可控。 某个redis机器岩机了，由于台数数量变化，会导致hash取余全部数据重新洗牌。</p>
<h4 id="一致性哈希算法"><a href="#一致性哈希算法" class="headerlink" title="一致性哈希算法"></a>一致性哈希算法</h4><p>一致性哈希算法在1997年由麻省理工学院中提出的，设计目标是为了解决 <strong>分布式缓存数据变动和映射问题</strong>，某个机器宕机了，分母数量改变了，自然取余数不OK了</p>
<p><strong>能干嘛：</strong></p>
<p>提出一致性Hash解决方案，目的是当服务器个数发生变动时，尽量减少影响客户端到服务器的映射关系</p>
<p><strong>3大步骤</strong></p>
<ul>
<li>算法构建一致性哈希环</li>
</ul>
<p>一致性哈希算法必然有个 hash 函数并按照算法产生 hash 值，这个 算法的所有可能 hash值 构成一个全量集，这个集合可以成为一个 hash空间 [0，2^32 - 1]，这个是一个线性空间，但是在算法中，我们通过适当的逻辑控制将它首尾相连 （0 &#x3D; 2 ^ 32），这样让它逻辑上形成了一个环形空间</p>
<p>他也是按照使用取模的方法， <strong>前面笔记介绍的节点取模法是对节点（服务器）的数量进行取模。而一致性 Hash 算法是对 2 ^ 32 取模</strong>，简单来说，<strong>一致性 Hash 算法将整个哈希值空间组织成一个虚拟的圆环</strong>，如 假设某哈希函数 H 的值空间 为 0 - 2 ^ 32 - 1(即哈希值是一个 32 位 无符号整形)，整个 哈希环 如下图 ： 整个空间 <strong>按顺序针方向组织</strong>，圆环的正上方的点代表 0 ，0 点右侧的第一个点代表 1，以此类推，2，3，4 … … 直到 2 ^ 32 - 1 ，也就是说 0 点左侧的第一个点 代表 2 ^ 32 - 1， 0 和 2 ^ 32 - 1 在 零点中方向重合，我们把这个由 2 ^ 32 个点组成的圆环成为 hash 环</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312122518309.png" alt="image-20230312122518309" style="zoom:50%;" /> 

<ul>
<li>服务器IP节点映射</li>
</ul>
<p>将集群中各个 IP 节点映射到 环上的某一个位置</p>
<p>将各个服务器使用 hash 进行一个 hash，具体可以选择服务器的 IP 或 主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。假设 4 个节点 Node A、B、C、D，经过 IP 地址的 <strong>哈希函数</strong> 计算（ hash(ip) ）,使用 IP 地址 哈希后在环空间的位置如下</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312123059222.png" alt="image-20230312123059222" style="zoom:50%;" /> 

<ul>
<li>key落到服务器的落键规则</li>
</ul>
<p>当我们需要存储一个 kv 键值对时，首先计算 key 的hash 值，hash(key),，将这个key 使用相同的函数 Hash 计算出 哈希值 并确定在此数据环上的位置，<strong>从此位置沿环顺时针 “行走”</strong>，第一台遇到的服务器就是其应该定位到的服务器，并将该键值对存储在该节点上</p>
<p>如我们有Object A、Object B、Object C、Object D四个数据对象，经过哈希计算后，在环空间上的位置如下：根据一致性Hash算法，数据A会被定为到Node A上，B被定为到Node B上，C被定为到Node C上，D被定为到Node D上。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312123607085.png" alt="image-20230312123607085" style="zoom:50%;" /> 

<p><font color='red'><strong>优点：</strong></font></p>
<ul>
<li>哈希算法的 <strong>容错性</strong></li>
</ul>
<p>假设 Node C 宕机，可以看到此时 A、B、D 不会受到影响。一般的，在 一致性 Hash 算法中，如果一台服务器不可用，则 <font color='red'>受影响的数据仅仅是此服务器到其环空间中前一台服务器（即沿逆时针方向行走遇到的第一台服务器） 之间数据，其他不会受到影响。</font>简单说，C 挂了，受到影响的 只是 B、C 之间 的数据 <strong>且这些数据会转移到 D 进行存储</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312124123568.png" alt="image-20230312124123568" style="zoom:50%;" /> 

<ul>
<li>哈希算法的 <strong>扩展性</strong></li>
</ul>
<p>数据量增加了，需要增加一台 Node x，X 的位置在 A 和 B 之间，那受到影响的只有 A 到 X 之间的 数据，重新把从 A 到 X 的 数据录入到 X 上即可，不会导致 hash 取余全部数据重新洗牌</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312124457726.png" alt="image-20230312124457726" style="zoom:50%;" />

<p><font color='red'><strong>缺点：</strong></font></p>
<p>一致性哈希算法的数据倾斜问题：</p>
<p>一致性 Hash 算法在服务 <strong>节点太少时</strong>，容易因为 节点分布不均而造成 <strong>数据倾斜</strong>（被缓存的对象大部分集中缓存在某一台服务器上） 问题，例如只有两台服务器时</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312124647270.png" alt="image-20230312124647270" style="zoom:50%;" /> 

<p><font color='red'><strong>总结：</strong></font></p>
<p>为了在节点数目发生改变时尽可能少的迁移数据，将所有的存储节点排列在收尾相接的Hash环上，每个key在计算Hash后会顺时针找到临近的存储节点存放。而当有节点加入或退出时仅影响该节点在Hash环上顺时针相邻的后续节点。</p>
<p><strong>优点</strong></p>
<p>加入和删除节点只影响哈希环中顺时针方向的相邻的节点，对其他节点无影响。</p>
<p><strong>缺点</strong></p>
<p>数据的分布和节点的位置有关，因为这些节点不是均匀的分布在哈希环上的，所以数据在进行存储时达不到均匀分布的效果。</p>
<h4 id="哈希槽分区（重要）"><a href="#哈希槽分区（重要）" class="headerlink" title="哈希槽分区（重要）"></a>哈希槽分区（重要）</h4><p><code>HASH_SLOT = CRC17(key) mod 16384</code> </p>
<p>哈希槽实质上就是一个数组，数组[0，2^14 - 1] 形成 hash slot 空间</p>
<p><strong>能干什么：</strong></p>
<p>解决均匀分配的问题，在数据和节点之间又加入了一层，把这层称为哈希槽（slot），用于管理数据和节点之间的关系，现在就相当于节点上放的是槽，槽里放的是数据</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723161333012.png" alt="image-20230723161333012" style="zoom:50%;" /> 

<p>槽解决的是粒度问题，相当于把粒度变大了，这样便于数据移动。哈希解决的是映射问题，使用 key 的哈希值来计算所在的槽，便于数据分配</p>
<p><strong>多少个hash槽：</strong></p>
<p>一个集群只能有16384个槽，编号0-16383（0-2^14-1）。这些槽会分配给集群中的所有主节点，分配策略没有要求。 集群会记录节点和槽的对应关系，解决了节点和槽的关系后，接下来就需要对key求哈希值，然后对16384取模，余数是几key就落入对应的槽里 HASH_SLOT&#x3D;CRC16(key)mod 16384。以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了。</p>
<p><font color='red'><strong>哈希槽计算：</strong></font></p>
<p>Redis 集群中内置了 16384 个哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。当需要在 Redis 集群中放置一个 key-value 时，redis 先对 key 使用 crc16算法算出一个结果，然后用结果对 16384 求余数 <code>[CRC16(key) % 16384]</code>，这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽，也就是映射到某个节点上。如下代码，key 之 A、B 在 Node2，key之 C 落在Node3上。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230723162149231.png" alt="image-20230723162149231"  /> 

<h3 id="Redis集群最大槽数是16384个"><a href="#Redis集群最大槽数是16384个" class="headerlink" title="Redis集群最大槽数是16384个"></a>Redis集群最大槽数是16384个</h3><p>redis 集群并没有用 一致性 hash 而是引入了 哈希槽的 概念。 <strong>redis 集群有 16384 个哈希槽</strong>，每个 key 通过 CRC16 校验后 对 16384 进行取模来决定防止哪个槽，集群的每一个节点负责一部分槽。但是 为什么是 16384 个呢？</p>
<blockquote>
<p>CRC16算法产生的hash值有16bit，该算法可以产生2^16&#x3D;65536个值。</p>
<p>换句话说值是分布在0~65535之间，有更大的65536不用为什么只用16384就够？</p>
<p>作者在做mod运算的时候，为什么不mod65536，而选择mod16384？ HASH_SLOT &#x3D; CRC16(key) mod 65536为什么没启用</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/redis/redis/issues/2576">https://github.com/redis/redis/issues/2576 </a></strong></p>
</blockquote>
<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>The reason is:</p>
<ol>
<li>Normal heartbeat packets carry the full configuration of a node, that can be replaced in an idempotent way with the old in order to update an old config. This means they contain the slots configuration for a node, in raw form, that uses 2k of space with16k slots, but would use a prohibitive 8k of space using 65k slots.</li>
<li>At the same time it is unlikely that Redis Cluster would scale to more than 1000 mater nodes because of other design tradeoffs.</li>
</ol>
<p>So 16k was in the right range to ensure enough slots per master with a max of 1000 maters, but a small enough number to propagate the slot configuration as a raw bitmap easily. Note that in small clusters the bitmap would be hard to compress because when N is small the bitmap would have slots&#x2F;N bits set that is a large percentage of bits set.</p>
<p>正常心跳包携带节点的完整配置，可以用旧配置以幂等的方式替换，以便更新旧配置。这意味着它们包含原始形式的节点插槽配置，该配置使用2k空间和16k插槽，但使用65k插槽时会使用禁止性的8k空间。<br>同时，由于其他设计上的权衡，Redis集群不太可能扩展到超过1000个主节点。<br>因此，16k是在正确的范围内，以确保每个主机有足够的插槽，最多1000个maters，但这个数字足够小，可以轻松地将插槽配置作为原始位图进行传播。注意，在小集群中，位图将很难压缩，因为当N较小时，位图将具有 slot &#x2F; N 位集 占设置为的很大百分比</p>
 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312194505703.png" alt="image-20230312194505703" style="zoom:67%;" />

<p><strong>（1）如果槽位为635536，发送心跳信息的消息头达8K，发送的心跳包过于庞大</strong></p>
<p>在消息头中最占空间的是myslots[CLUSTER_SLOTS&#x2F;8]。 当槽位为65536时，这块的大小是: 65536÷8÷1024&#x3D;8kb</p>
<p>在消息头中最占空间的是myslots[CLUSTER_SLOTS&#x2F;8]。 当槽位为16384时，这块的大小是: 16384÷8÷1024&#x3D;2kb</p>
<p>因为每秒钟，redis节点需要发送一定数量的ping消息作为心跳包，如果槽位为65536，这个ping消息的消息头太大了，浪费带宽。</p>
<p><strong>（2）redis的集群主节点数量基本不可能超过1000个</strong></p>
<p>集群节点越多，心跳包的消息体内携带的数据越多。如果节点过1000个，也会导致网络拥堵。因此redis作者不建议redis cluster节点数量超过1000个。 那么，对于节点数在1000以内的redis cluster集群，16384个槽位够用了。没有必要拓展到65536个。</p>
<p><strong>（3）槽位越小，节点少的情况下，压缩比高，容易传输</strong></p>
<p>Redis主节点的配置信息中它所负责的哈希槽是通过一张bitmap的形式来保存的，在传输过程中会对bitmap进行压缩，但是如果bitmap的填充率 slots &#x2F; N 很高的话(N表示节点数)，bitmap的压缩率就很低。 如果节点数很少，而哈希槽数量很多的话，bitmap的压缩率就很低。</p>
<p><font color='red'><strong>注意：</strong></font></p>
<p>Redis Cluster uses asynchronous replication between nodes, and <strong>last failover wins</strong> implicit merge function. This means that the last elected master dataset eventually replaces all the other replicas. There is always a window of time when it is possible to lose writes during partitions. However these windows are very different in the case of a client that is connected to the majority of masters, and a client that is connected to the minority of masters.</p>
<p>Redis集群使用节点间异步复制，最后一次故障转移赢得隐式合并功能。这意味着最后选择的主数据集最终会替换所有其他副本。在分区期间，总有一个时间窗口可能会丢失写入。然而，在一个客户端连接到大多数主机，一个客户端连接到少数主机的情况下，这些窗口是非常不同的。</p>
<blockquote>
<p>redis 集群<strong>不保证强一致性</strong>，这意味着在特定的条件下，redis 集群可能会丢掉一些被系统收到的写入请求命令</p>
</blockquote>
<h2 id="案例-3"><a href="#案例-3" class="headerlink" title="案例"></a>案例</h2><h3 id="三主三从redis集群配置"><a href="#三主三从redis集群配置" class="headerlink" title="三主三从redis集群配置"></a>三主三从redis集群配置</h3><ul>
<li><p>新建3台虚拟机，里面新建 <code>mkdir -p /myredis/cluster</code> </p>
</li>
<li><p>新建6个独立的redis实例服务</p>
<ul>
<li><p>IP：192.168.200.129 ，端口：6381、6382</p>
<ul>
<li><p><code>vim /myredis/cluster/redisCluster6381.conf</code> </p>
<pre class="line-numbers language-redisCluster6381.conf" data-language="redisCluster6381.conf"><code class="language-redisCluster6381.conf">bind 0.0.0.0
daemonize yes
protected-mode no
port 6381
logfile &quot;&#x2F;myredis&#x2F;cluster&#x2F;cluster6381.log&quot;
pidfile &#x2F;myredis&#x2F;cluster6381.pid
dir &#x2F;myredis&#x2F;cluster
dbfilename dump6381.rdb
appendonly yes
appendfilename &quot;appendonly6381.aof&quot;
requirepass 111111
masterauth 111111
 
cluster-enabled yes
cluster-config-file nodes-6381.conf
cluster-node-timeout 5000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>vim /myredis/cluster/redisCluster6382.conf</code> </p>
<pre class="line-numbers language-redisCluster6382.conf" data-language="redisCluster6382.conf"><code class="language-redisCluster6382.conf">bind 0.0.0.0
daemonize yes
protected-mode no
port 6382
logfile &quot;&#x2F;myredis&#x2F;cluster&#x2F;cluster6382.log&quot;
pidfile &#x2F;myredis&#x2F;cluster6382.pid
dir &#x2F;myredis&#x2F;cluster
dbfilename dump6382.rdb
appendonly yes
appendfilename &quot;appendonly6382.aof&quot;
requirepass 111111
masterauth 111111
 
cluster-enabled yes
cluster-config-file nodes-6382.conf
cluster-node-timeout 5000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
<li><p>IP ：192.168.200.132    端口：6383、6384</p>
<ul>
<li><p><code>vim /myredis/cluster/redisCluster6383.conf</code>  </p>
<pre class="line-numbers language-redisCluster6383.conf" data-language="redisCluster6383.conf"><code class="language-redisCluster6383.conf">bind 0.0.0.0
daemonize yes
protected-mode no
port 6383
logfile &quot;&#x2F;myredis&#x2F;cluster&#x2F;cluster6383.log&quot;
pidfile &#x2F;myredis&#x2F;cluster6383.pid
dir &#x2F;myredis&#x2F;cluster
dbfilename dump6383.rdb
appendonly yes
appendfilename &quot;appendonly6383.aof&quot;
requirepass 111111
masterauth 111111

cluster-enabled yes
cluster-config-file nodes-6383.conf
cluster-node-timeout 5000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>vim /myredis/cluster/redisCluster6384.conf</code>   </p>
<pre class="line-numbers language-redisCluster6384.conf" data-language="redisCluster6384.conf"><code class="language-redisCluster6384.conf">bind 0.0.0.0
daemonize yes
protected-mode no
port 6384
logfile &quot;&#x2F;myredis&#x2F;cluster&#x2F;cluster6384.log&quot;
pidfile &#x2F;myredis&#x2F;cluster6384.pid
dir &#x2F;myredis&#x2F;cluster
dbfilename dump6384.rdb
appendonly yes
appendfilename &quot;appendonly6384.aof&quot;
requirepass 111111
masterauth 111111
 
cluster-enabled yes
cluster-config-file nodes-6384.conf
cluster-node-timeout 5000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
<li><p>IP ：192.168.200.133    端口：6385、6386</p>
<ul>
<li><p><code>vim /myredis/cluster/redisCluster6385.conf</code> </p>
<pre class="line-numbers language-redisCluster6385.conf" data-language="redisCluster6385.conf"><code class="language-redisCluster6385.conf">bind 0.0.0.0
daemonize yes
protected-mode no
port 6385
logfile &quot;&#x2F;myredis&#x2F;cluster&#x2F;cluster6385.log&quot;
pidfile &#x2F;myredis&#x2F;cluster6385.pid
dir &#x2F;myredis&#x2F;cluster
dbfilename dump6385.rdb
appendonly yes
appendfilename &quot;appendonly6385.aof&quot;
requirepass 111111
masterauth 111111
 
cluster-enabled yes
cluster-config-file nodes-6385.conf
cluster-node-timeout 5000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>vim /myredis/cluster/redisCluster6386.conf</code>  </p>
<pre class="line-numbers language-redisCluster6386.conf" data-language="redisCluster6386.conf"><code class="language-redisCluster6386.conf">bind 0.0.0.0
daemonize yes
protected-mode no
port 6386
logfile &quot;&#x2F;myredis&#x2F;cluster&#x2F;cluster6386.log&quot;
pidfile &#x2F;myredis&#x2F;cluster6386.pid
dir &#x2F;myredis&#x2F;cluster
dbfilename dump6386.rdb
appendonly yes
appendfilename &quot;appendonly6386.aof&quot;
requirepass 111111
masterauth 111111
 
cluster-enabled yes
cluster-config-file nodes-6386.conf
cluster-node-timeout 5000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
</ul>
</li>
<li><p>在各个虚拟机中分别启动他们的redis实例</p>
<ul>
<li><code>redis-server /myredis/cluster/redisCluster6381.conf</code></li>
</ul>
</li>
<li><p>通过 <code>redis-cli</code> 命令为这6台机器构建集群关系</p>
<ul>
<li><p>构建主从关系</p>
<pre class="line-numbers language-3主3从" data-language="3主3从"><code class="language-3主3从">redis-cli -a 111111 --cluster create --cluster-replicas 1 192.168.200.129:6381 192.168.200.129:6382 192.168.200.132:6383 192.168.200.132:6384 192.168.200.133:6385 192.168.200.133:6386<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724100213652.png" alt="image-20230724100213652" style="zoom:80%;" /><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724100247060.png" alt="image-20230724100247060" style="zoom:80%;" /></p>
</li>
</ul>
<p><font color='red'><strong>注意：</strong></font></p>
<p>在搭建Redis集群的过程中，执行到 <code>cluter create ...</code> 的时候，发现程序阻塞，显示：<code>Waiting for the cluster to join ...</code> 且一直点个没完，这种情况大部分是因为 <strong>集群总线</strong> 的端口没有开放</p>
<blockquote>
<p><strong>集群总线</strong><br> 每个Redis集群中的节点都需要打开两个TCP连接。一个连接用于正常的给Client提供服务，比如6379，还有一个额外的端口（通过在这个端口号上加10000）作为数据端口，例如：**<code>redis的端口为6379，那么另外一个需要开通的端口是：6379 + 10000， 即需要开启 16379</code>**。16379端口用于集群总线，这是一个用二进制协议的点对点通信信道。这个集群总线（Cluster bus）用于节点的失败侦测、配置更新、故障转移授权，等等。</p>
</blockquote>
<p><font color='red'><strong>解决：</strong></font></p>
<ul>
<li>开放指定端口：</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">firewall-cmd --zone&#x3D;public --add-port&#x3D;6381&#x2F;tcp --permanent 
firewall-cmd --zone&#x3D;public --add-port&#x3D;16381&#x2F;tcp --permanent 
等等<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>重启防火墙</p>
<pre class="line-numbers language-none"><code class="language-none">firewall-cmd --reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>查看是否开启端口</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F;查看指定区域所有打开的端口
firewall-cmd --zone&#x3D;public --list-ports
&#x2F;&#x2F;查看指定端口是否打开
firewall-cmd --query-port&#x3D;6379&#x2F;tcp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查看redis服务进程</p>
<pre class="line-numbers language-none"><code class="language-none">ps -ef|grep redis<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>关闭redis服务进程</p>
<pre class="line-numbers language-none"><code class="language-none">kill -9 [redis进程号]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>重启redis服务即可</p>
<pre class="line-numbers language-none"><code class="language-none">redis-server &#x2F;myredis&#x2F;cluster&#x2F;redisCluster6381.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<p><strong>连接：</strong> 进入6381，查看并检验集群状态</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724103344012.png" alt="image-20230724103344012"></p>
<ul>
<li><p><code>cluster nodes</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724103503706.png" alt="image-20230724103503706"></p>
</li>
<li><p><code>info replication</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724103709011.png" alt="image-20230724103709011"> </p>
</li>
<li><p><code>cluster info</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724103742602.png" alt="image-20230724103742602"></p>
</li>
</ul>
<p><font color='red'><strong>注意：</strong></font></p>
<p>当输入信息的时候，hash计算的不同编号进入其相对应的槽位内，所以当启动 6381的时候，如果写入的数据算出来不是其槽内号的话，不能输入，如果想要输入，则需要在启动redis的时候加入 <code>-c</code> ，即：</p>
<pre class="line-numbers language-none"><code class="language-none">redis -cli -a 111111 -p 6381 -c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>加入 <code>-c</code> 就可以切换槽位写入数据，不用来回切换redis。</p>
<h3 id="主从容错切换迁移案例"><a href="#主从容错切换迁移案例" class="headerlink" title="主从容错切换迁移案例"></a>主从容错切换迁移案例</h3><p>容错切换转移</p>
<ul>
<li><p>将主 6381 宕机：<code>shutdown</code>  <code>quit</code> </p>
<ul>
<li>此时6381宕机，一般来说是对应的 6384 从机上位</li>
<li>6381 作为 1 号主机分配的从机以实际情况为准，具体是几号机器就是几号机器</li>
</ul>
</li>
<li><p>6381宕机重启后 查看集群信息，主从关系</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724105349780.png" alt="image-20230724105349780"></p>
</li>
</ul>
<p>发现 6384 上位成为了主机，6381成为了6384的从机</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724105713973.png" alt="image-20230724105713973" style="zoom:80%;" /> 

<ul>
<li><p>集群不保证数据一致性 100 %OK，一定会有数据丢失情况</p>
<ul>
<li>redis 集群不保证强一致性，这意味着在特定的条件下，redis 集群可能会丢掉一些被系统收到的写入请求命令</li>
</ul>
</li>
<li><p>节点主从调整</p>
<ul>
<li>上面换后 6381 和 6384 主从对调了，和原始不一样了，该怎么办</li>
<li>重新登陆 6381 机器，执行 <code>cluster failover</code> 命令</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724105951766.png" alt="image-20230724105951766"></p>
</li>
</ul>
<p>发现6381和6382成功调换了，6381又成为6384的主机了</p>
<h3 id="集群扩容案例"><a href="#集群扩容案例" class="headerlink" title="集群扩容案例"></a>集群扩容案例</h3><ul>
<li><p>新建6387、 6388两个服务实例配置文件 + 新建后启动</p>
</li>
<li><p>启动 87、 88两个新节点实例，此时他们自己都是 master</p>
</li>
<li><p>将新增的 6387 节点（空槽号）作为 master 节点加入原集群</p>
<ul>
<li>将新增的 6387 作为 master节点加入原有集群</li>
<li>命令模版：<code>redis-cli -a 密码 --cluster add-node 自己实际IP地址:6387 自己实际IP地址:6381</code>  </li>
<li>6387 就是将要作为 master新增节点</li>
<li>6381 就是原来集群节点里面的领路人，相当于 6387 拜 6381的码头从而找到组织加入集群</li>
<li>命令：<code>redis-cli -a 111111 --cluster add-node 192.168.200.133:6387 192.168.200.129:6381</code></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724113508303.png" alt="image-20230724113508303"></p>
</li>
<li><p>检查集群情况第1次 </p>
<ul>
<li><code>redis-cli -a 111111 --cluster check 192.168.200.129:6381</code></li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724113736167.png" alt="image-20230724113736167"  />
</li>
<li><p>重新分派槽号（reshard）</p>
<ul>
<li><code>redis-cli -a 111111 --cluster reshard 192.168.200.129:6381</code></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724114902855.png" alt="image-20230724114902855"></p>
</li>
<li><p>检查集群情况第2次</p>
<ul>
<li><code>redis-cli -a 111111 --cluster check 192.168.200.129.6381</code></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724124708555.png" alt="image-20230724124708555"></p>
<ul>
<li><p>槽号分派说明：为什么6387是3个新区间（0-1364，5461-6826,10923-12287），6381、6383、 6385还是连续的</p>
<p>因为：重新分配成本太高，所以前3家各自匀出来一部分，从6381&#x2F;6383&#x2F;6385三个旧节点分别匀出1364个坑位给新节点6387</p>
</li>
</ul>
</li>
<li><p>为主节点 6387 分配从节点 6388</p>
<ul>
<li>命令模版：<code>redis-cli -a 密码 --cluster add-node ip:新slave端口 ip:新master端口 --cluster-slave --cluster-master-id 新主机节点ID</code></li>
<li>命令：<code>redis-cli -a 111111 --cluster add-node 192.168.200.133:6388 192.168.200.133:6387 --cluster-slave --cluster-master-id 6e35c954e8eba5fadfeb99b9c5bf1a0f8bfbeca8</code> （注意，最后的这个ID是主机6387的ID编号，按照自己实际情况写）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724130400647.png" alt="image-20230724130400647"></p>
</li>
<li><p>检查集群情况第 3 次</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724130823779.png" alt="image-20230724130823779"></p>
<h3 id="集群缩容案例"><a href="#集群缩容案例" class="headerlink" title="集群缩容案例"></a>集群缩容案例</h3><p>目的：6387 和 6388下线</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724131132075.png" alt="image-20230724131132075" style="zoom: 50%;" /> 

<ul>
<li><p>检查集群情况第一次，先获得从节点 6388的节点ID</p>
<ul>
<li><code>redis-cli -a 111111 --cluster check 192.168.200.133:6388</code></li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724131648900.png" alt="image-20230724131648900"  /> 
</li>
<li><p>从集群中将4号从节点6388 删除</p>
<ul>
<li>命令模版：<code>redis-cli -a 密码 --cluster del-node ip:从机端口 从机6388节点ID</code> </li>
<li>命令：<code>redis-cli -a 111111 --cluster del-node 192.168.200.133:6388 01c4f0dffe9c77dcae125a0489614066103e294c</code></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724132331815.png" alt="image-20230724132331815"></p>
<p>检查一下，发现只剩下 7 台机器了，6388从节点被删除了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724132624821.png" alt="image-20230724132624821"></p>
</li>
<li><p>将6387 的槽号清空，重新分配，本例将清出来的槽号都给 6381 </p>
<ul>
<li><code>redis-cli -a 111111 --cluster reshard 192.168.200.129:6381</code></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724132928455.png" alt="image-20230724132928455"></p>
</li>
<li><p>检查集群情况第二次</p>
<ul>
<li><code>redis-cli -a 111111 --cluster check 192.168.200.129:6381</code> </li>
<li>4096 个槽位都指给6381，它变成了8192个槽位，相当于全部都给了6381了，不然要输入3次，一锅端</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724133302764.png" alt="image-20230724133302764"></p>
</li>
<li><p>将6387删除</p>
<ul>
<li>命令：<code>redis-cli -a 111111 --cluster del-node 192.168.200.133:6387 6e35c954e8eba5fadfeb99b9c5bf1a0f8bfbeca8</code></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724133707092.png" alt="image-20230724133707092"></p>
</li>
<li><p>检查集群情况第三次，6387、 6388被彻底去除</p>
<ul>
<li><code>redis-cli -a 111111 --cluster check 192.168.200.129:6381</code></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724133824257.png" alt="image-20230724133824257"></p>
</li>
</ul>
<h2 id="集群常用操作命令和CRC16算法分析"><a href="#集群常用操作命令和CRC16算法分析" class="headerlink" title="集群常用操作命令和CRC16算法分析"></a>集群常用操作命令和CRC16算法分析</h2><ul>
<li><p>不在同一个slot槽位下的多键操作支持不好，通识占位符登场</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312222100122.png" alt="image-20230312222100122" style="zoom:50%;" /> 

<p><font color='red'><strong>注意：</strong></font> 不在同一个slot槽位下的键值无法使用mset、mget等多键操作</p>
<p><font color='red'>**解决： **</font>可以通过{}来定义同一个组的概念，使key中{}内相同内容的键值对放到一个slot槽位去，对照下图类似 k1 k2 k3 都映射为 x，自然槽位一样</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230312222121424.png" alt="image-20230312222121424" style="zoom:50%;" /> 
</li>
<li><p>Redis集群有16384个哈希槽，每个key 通过 CRC16校验后对16384 取模来决定放置哪个槽。集群的每个节点负责一部分hash槽</p>
<p><strong>CRC16</strong> ：</p>
<ul>
<li>redis 集群有 16384 个哈希槽，每个key 通过 CRC16 校验后对 16384 进行取模，来决定放置那个槽，集群的每个节点负责一部分 hash槽</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724135221491.png" alt="image-20230724135221491" style="zoom: 80%;" /></li>
</ul>
<p><strong>常用命令：</strong></p>
<ul>
<li><p>集群是否完整才能对外提供服务：<code>cluster-require-full-coverage</code> </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724135523178.png" alt="image-20230724135523178" style="zoom: 50%;" />

<p>默认YES，现在集群架构是3主3从的 redis cluster由 3 个master平分 16384 个 slot,每个master的小集群负责 1&#x2F;3的slot,对应一部分数据。 cluster-require-full-coverage：默认值yes，即需要集群完整性，方可对外提供服务通常情况，如果这3个小集群中，任何一个（1主1人 挂了，你这个集群对外可提供的数据只有2&#x2F;3了，整个集群是不完整的，redis默认在这种情况下，是不会对外提供服务的。</p>
<p>如果你的诉求是，集群不完整的话也需要对外提供服务，需要将该参数设置为no,这样的话你挂了的那个小集群是不行了，但是其他的小集群 仍然可以对外提供服务 </p>
</li>
<li><p><code>cluster countkeysinslot 槽位数字编号</code> </p>
<ul>
<li>1：该槽位被占用</li>
<li>0：该槽位没占用</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724135936348.png" alt="image-20230724135936348" style="zoom: 50%;" /> 
</li>
<li><p><code>cluster keyslot 键名称</code>  ：该键应该存在哪个槽位上</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724140023102.png" alt="image-20230724140023102" style="zoom:50%;" /></li>
</ul>
<h1 id="Springboot整合Redis"><a href="#Springboot整合Redis" class="headerlink" title="Springboot整合Redis"></a>Springboot整合Redis</h1><p><strong>总体概述：</strong> jedis-lettuce-RedisTemplate三者的联系</p>
<p><strong>本地Java连接Redis常见问题：</strong></p>
<ul>
<li>bind 配置注释掉</li>
<li>保护模式设置为 no</li>
<li>Linux系统的防火墙设置</li>
<li>redis 服务器的IP地址和密码是否正确</li>
<li>忘记写访问 redis的服务端口号 和 auth密码</li>
</ul>
<h2 id="集成Jedis"><a href="#集成Jedis" class="headerlink" title="集成Jedis"></a>集成Jedis</h2><p>Jedis Client 是 Redis 官网推荐的一个面向java客户端，库文件实现了对各类API进行封装调用</p>
<p><strong>步骤：</strong></p>
<ul>
<li><p>建 Module</p>
</li>
<li><p>改 pom文件（加Jedis相关依赖）</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"> <span class="token comment">&lt;!--jedis--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>写 YML</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">server.port=7777

spring.application.name=redis7_study<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>主启动</p>
</li>
<li><p>业务类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">//1. 获取connect连接</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"192.168.200.129"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.连接密码</span>
        jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">"abc123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//测试</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//测试set、get</span>
        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//测试 mset、mget</span>
        jedis<span class="token punctuation">.</span><span class="token function">mset</span><span class="token punctuation">(</span><span class="token string">"k2"</span><span class="token punctuation">,</span> <span class="token string">"v2"</span><span class="token punctuation">,</span> <span class="token string">"k3"</span><span class="token punctuation">,</span> <span class="token string">"v3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">mget</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">,</span> <span class="token string">"k3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string">"k3"</span><span class="token punctuation">,</span> <span class="token number">20L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//测试list集合</span>
        jedis<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">"k4"</span><span class="token punctuation">,</span><span class="token string">"v4"</span><span class="token punctuation">,</span><span class="token string">"a4"</span><span class="token punctuation">,</span><span class="token string">"b4"</span><span class="token punctuation">,</span><span class="token string">"c4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">lrange</span><span class="token punctuation">(</span><span class="token string">"k4"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//测试set</span>
        jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"v3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> set1 <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">smembers</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> iterator <span class="token operator">=</span> set1<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        jedis<span class="token punctuation">.</span><span class="token function">srem</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span><span class="token string">"v2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//测试hash</span>
        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">,</span> <span class="token string">"userName"</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span><span class="token string">"hash1"</span><span class="token punctuation">,</span> <span class="token string">"userName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"userName"</span><span class="token punctuation">,</span> <span class="token string">"wangwu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"telephone"</span><span class="token punctuation">,</span> <span class="token string">"11111111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">,</span> <span class="token string">"xxxx.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">hmset</span><span class="token punctuation">(</span><span class="token string">"hash2"</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">hmget</span><span class="token punctuation">(</span><span class="token string">"hash2"</span><span class="token punctuation">,</span> <span class="token string">"telephone"</span><span class="token punctuation">,</span> <span class="token string">"email"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//测试 zset</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">"v1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token string">"v2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token string">"v3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span><span class="token number">600</span><span class="token punctuation">,</span><span class="token string">"v4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">zincrby</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">"v2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">zrange</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">zcount</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h2 id="集成Lettuce"><a href="#集成Lettuce" class="headerlink" title="集成Lettuce"></a>集成Lettuce</h2><p>Lettuce是一个Redis的Java驱动包</p>
<p><strong>Lettuce和Jedis的区别：</strong></p>
<p>jedis和Lettuce都是Redis的客户端，它们都可以连接Redis服务器，<strong>但是在SpringBoot2.0之后默认都是使用的Lettuce这个客户端连接Redis服务器</strong>。因为当使用Jedis客户端连接Redis服务器的时候，每个线程都要拿自己创建的Jedis实例去连接Redis客户端，当有很多个线程的时候，不仅开销大需要反复的创建关闭一个Jedis连接，而且也是线程不安全的，一个线程通过Jedis实例更改Redis服务器中的数据之后会影响另一个线程；但是如果使用Lettuce这个客户端连接Redis服务器的时候，就不会出现上面的情况，<strong>Lettuce底层使用的是Netty</strong>,当有多个线程都需要连接Redis服务器的时候，可以保证只创建一个Lettuce连接，使所有的线程共享这一个Lettuce连接，这样可以减少创建关闭一个Lettuce连接时候的开销；而且这种方式也是线程安全的，不会出现一个线程通过Lettuce更改Redis服务器中的数据之后而影响另一个线程的情况；</p>
<ul>
<li><p>配置和Jedis一样</p>
</li>
<li><p>pom文件：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--lettuce--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>6.2.1.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>业务类：</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LettuceDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">//1. 使用构建器链式编程来builder我们RedisURI</span>
        <span class="token class-name">RedisURI</span> uri <span class="token operator">=</span> <span class="token class-name">RedisURI</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">redis</span><span class="token punctuation">(</span><span class="token string">"192.168.200.129"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withPort</span><span class="token punctuation">(</span><span class="token number">6379</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withAuthentication</span><span class="token punctuation">(</span><span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"abc123"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.创建连接客户端</span>
        <span class="token class-name">RedisClient</span> redisClient <span class="token operator">=</span> <span class="token class-name">RedisClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StatefulRedisConnection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> conn <span class="token operator">=</span> redisClient<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.通过conn创建操作的command</span>
        <span class="token class-name">RedisCommands</span> commands <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//string</span>
        commands<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span><span class="token string">"v1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>commands<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//4.关闭资源</span>
        conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisClient<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="集成RedisTemplate（重要）"><a href="#集成RedisTemplate（重要）" class="headerlink" title="集成RedisTemplate（重要）"></a>集成RedisTemplate（重要）</h2><h3 id="连接单机"><a href="#连接单机" class="headerlink" title="连接单机"></a>连接单机</h3><ul>
<li><p>建 Module</p>
</li>
<li><p>改 pom文件</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--引入Redis--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--swagger2--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.springfox<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>springfox-swagger2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.springfox<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>springfox-swagger-ui<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>写 yml或properties文件</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">7777</span>

<span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">redis7_study</span>

<span class="token comment"># ========================logging=====================</span>
<span class="token key attr-name">logging.level.root</span><span class="token punctuation">=</span><span class="token value attr-value">info</span>
<span class="token key attr-name">logging.level.com.byxl8112</span><span class="token punctuation">=</span><span class="token value attr-value">info</span>
<span class="token key attr-name">logging.pattern.console</span><span class="token punctuation">=</span><span class="token value attr-value">%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger- %msg%n </span>

<span class="token key attr-name">logging.file.name</span><span class="token punctuation">=</span><span class="token value attr-value">D:/mylogs2023/redis7_study.log</span>
<span class="token key attr-name">logging.pattern.file</span><span class="token punctuation">=</span><span class="token value attr-value">%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger- %msg%n</span>

<span class="token comment"># ========================swagger=====================</span>
<span class="token key attr-name">spring.swagger2.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#在springboot2.6.X结合swagger2.9.X会提示documentationPluginsBootstrapper空指针异常，</span>
<span class="token comment">#原因是在springboot2.6.X中将SpringMVC默认路径匹配策略从AntPathMatcher更改为PathPatternParser，</span>
<span class="token comment"># 导致出错，解决办法是matching-strategy切换回之前ant_path_matcher</span>
<span class="token key attr-name">spring.mvc.pathmatch.matching-strategy</span><span class="token punctuation">=</span><span class="token value attr-value">ant_path_matcher</span>

<span class="token comment"># ========================redis单机=====================</span>
<span class="token key attr-name">spring.redis.database</span><span class="token punctuation">=</span><span class="token value attr-value">0</span>
<span class="token comment"># 修改为自己真实IP</span>
<span class="token key attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.200.129</span>
<span class="token key attr-name">spring.redis.port</span><span class="token punctuation">=</span><span class="token value attr-value">6379</span>
<span class="token key attr-name">spring.redis.password</span><span class="token punctuation">=</span><span class="token value attr-value">abc123</span>
<span class="token key attr-name">spring.redis.lettuce.pool.max-active</span><span class="token punctuation">=</span><span class="token value attr-value">8</span>
<span class="token key attr-name">spring.redis.lettuce.pool.max-wait</span><span class="token punctuation">=</span><span class="token value attr-value">-1ms</span>
<span class="token key attr-name">spring.redis.lettuce.pool.max-idle</span><span class="token punctuation">=</span><span class="token value attr-value">8</span>
<span class="token key attr-name">spring.redis.lettuce.pool.min-idle</span><span class="token punctuation">=</span><span class="token value attr-value">0</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>主启动</p>
</li>
<li><p>业务类</p>
<ul>
<li><p>配置类：RedisConfig.java</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>byxl8112<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>lettuce<span class="token punctuation">.</span></span><span class="token class-name">LettuceConnectionFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @auther zzyy
 * @create 2022-11-17 17:34
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * redis序列化的工具配置类，下面这个请一定开启配置
     * 127.0.0.1:6379> keys *
     * 1) "ord:102"  序列化过
     * 2) "\xac\xed\x00\x05t\x00\aord:102"   野生，没有序列化过
     * this.redisTemplate.opsForValue(); //提供了操作string类型的所有方法
     * this.redisTemplate.opsForList(); // 提供了操作list类型的所有方法
     * this.redisTemplate.opsForSet(); //提供了操作set的所有方法
     * this.redisTemplate.opsForHash(); //提供了操作hash表的所有方法
     * this.redisTemplate.opsForZSet(); //提供了操作zset的所有方法
     * @param lettuceConnectionFactory
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">LettuceConnectionFactory</span> lettuceConnectionFactory<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>lettuceConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置key序列化方式string</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置value的序列化方式json，使用GenericJackson2JsonRedisSerializer替换默认序列化</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        redisTemplate<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>配置类：SwaggerConfig.java</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>redis7<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">ApiInfoBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">PathSelectors</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">RequestHandlerSelectors</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ApiInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>spi<span class="token punctuation">.</span></span><span class="token class-name">DocumentationType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>web<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span></span><span class="token class-name">Docket</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>swagger2<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">EnableSwagger2</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span><span class="token class-name">DateTimeFormatter</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @auther zzyy
 * @create 2022-11-17 17:44
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerConfig</span>
<span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;spring.swagger2.enabled&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> enabled<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Docket</span> <span class="token function">createRestApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Docket</span><span class="token punctuation">(</span><span class="token class-name">DocumentationType</span><span class="token punctuation">.</span>SWAGGER_2<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>enabled<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apis</span><span class="token punctuation">(</span><span class="token class-name">RequestHandlerSelectors</span><span class="token punctuation">.</span><span class="token function">basePackage</span><span class="token punctuation">(</span><span class="token string">"com.byxl8112"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//你自己的package</span>
                <span class="token punctuation">.</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token class-name">PathSelectors</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">ApiInfo</span> <span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApiInfoBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">"springboot利用swagger2构建api接口文档 "</span><span class="token operator">+</span><span class="token string">"\t"</span><span class="token operator">+</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"springboot+redis整合,有问题给管理员阳哥邮件:zzyybs@126.com"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">"1.0"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">termsOfServiceUrl</span><span class="token punctuation">(</span><span class="token string">"https://www.byxl8112.com/"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>service ：OrderService.java</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>redis7<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">ApiInfoBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">PathSelectors</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">RequestHandlerSelectors</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ApiInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>spi<span class="token punctuation">.</span></span><span class="token class-name">DocumentationType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>web<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span></span><span class="token class-name">Docket</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>swagger2<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">EnableSwagger2</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span><span class="token class-name">DateTimeFormatter</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @auther zzyy
 * @create 2022-11-17 17:44
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerConfig</span>
<span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;spring.swagger2.enabled&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> enabled<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Docket</span> <span class="token function">createRestApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Docket</span><span class="token punctuation">(</span><span class="token class-name">DocumentationType</span><span class="token punctuation">.</span>SWAGGER_2<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>enabled<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apis</span><span class="token punctuation">(</span><span class="token class-name">RequestHandlerSelectors</span><span class="token punctuation">.</span><span class="token function">basePackage</span><span class="token punctuation">(</span><span class="token string">"com.byxl8112"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//你自己的package</span>
                <span class="token punctuation">.</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token class-name">PathSelectors</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">ApiInfo</span> <span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApiInfoBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">"springboot利用swagger2构建api接口文档 "</span><span class="token operator">+</span><span class="token string">"\t"</span><span class="token operator">+</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"springboot+redis整合,有问题给管理员阳哥邮件:zzyybs@126.com"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">"1.0"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">termsOfServiceUrl</span><span class="token punctuation">(</span><span class="token string">"https://www.byxl8112.com/"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>controller ：OrderController.java</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>byxl8112<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>byxl8112<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OrderService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMethod</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author liang_8112
 * @create 2023-07-24-19:40
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">"订单接口"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"新增订单"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/order/add"</span><span class="token punctuation">,</span> method<span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        orderService<span class="token punctuation">.</span><span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"按照keyId查询订单"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/order/&#123;id&#125;"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span>  <span class="token function">getOrderById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> orderService<span class="token punctuation">.</span><span class="token function">getOrderById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
<li><p>测试</p>
<p>swagger：<code>http://localhost:7777/swagger-ui.html#/</code> </p>
<p><strong>序列化问题：</strong> </p>
<ul>
<li><p>第一种解决方案：键（key）和值（value）都是通过Spring提供的Serializer序列化到数据库的，RedisTemplate默认使用的是 JdkSerializationRedisSerializer，StringRedisTemplate默认使用的是 StringRedisSerializer。</p>
<p>开启redis数据库的时候加入 <code>--raw</code> </p>
<pre class="line-numbers language-none"><code class="language-none">redis-cli -a abc123 -p 6379 --raw<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724203449660.png" alt="image-20230724203449660"></p>
<p>key 被序列化成这样，线上通过key去查询对应的value非常不方便</p>
</li>
<li><p>第二种解决方案：（JDK序列化方式（默认）惹的祸）</p>
<p>加入RedisConfig.java类指定一个序列化，代码在上面</p>
</li>
</ul>
</li>
</ul>
<h3 id="连接集群"><a href="#连接集群" class="headerlink" title="连接集群"></a>连接集群</h3><p>首先在虚拟机中启动6台redis</p>
<ul>
<li><p>第一次：改写yaml</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">server.port=7777

spring.application.name=redis7_study

# ========================logging=====================
logging.level.root=info
logging.level.com.atguigu.redis7=info
logging.pattern.console=%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger- %msg%n 

logging.file.name=D:/mylogs2023/redis7_study.log
logging.pattern.file=%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger- %msg%n

# ========================swagger=====================
spring.swagger2.enabled=true
#在springboot2.6.X结合swagger2.9.X会提示documentationPluginsBootstrapper空指针异常，
#原因是在springboot2.6.X中将SpringMVC默认路径匹配策略从AntPathMatcher更改为PathPatternParser，
# 导致出错，解决办法是matching-strategy切换回之前ant_path_matcher
spring.mvc.pathmatch.matching-strategy=ant_path_matcher


# ========================redis集群=====================
spring.redis.password=111111
# 获取失败 最大重定向次数
spring.redis.cluster.max-redirects=3
spring.redis.lettuce.pool.max-active=8
spring.redis.lettuce.pool.max-wait=-1ms
spring.redis.lettuce.pool.max-idle=8
spring.redis.lettuce.pool.min-idle=0
spring.redis.cluster.nodes=192.168.111.175:6381,192.168.111.175:6382,192.168.111.172:6383,192.168.111.172:6384,192.168.111.174:6385,192.168.111.174:6386<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>添加数据后在用命令 <code>redis-cli -a 密码 -p 端口号 -c --raw</code> 打开redis ，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724205920495.png" alt="image-20230724205920495"></p>
</li>
</ul>
<p><strong>问题：</strong></p>
<ul>
<li>人为模拟，master-6381 机器意外宕机，手动 shutdown</li>
<li>先对 redis集群命令方式，手动验证各种读写命令，看看 6384 是否上位</li>
<li>redis cluster 集群能够自动感应并自动完成主备切换，对应的 slave 6384 会被选举为新的 master 节点</li>
</ul>
<p><strong>故障现象：</strong> </p>
<ul>
<li><p>SpringBoot客户端没有动态感知到 RedisCluster 的最新集群信息</p>
</li>
<li><p>经典故障</p>
<ul>
<li>【故障演练】Redis Cluster 集群部署采用了3主3从拓扑结构，数据读写访问 master 节点，slave节点负责备份。当master宕机主从切换成功，redis手动OK，但是有两个经典故障</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230724210539073.png" alt="image-20230724210539073"></p>
</li>
</ul>
<p> <font color='red'><strong>解决方案：</strong></font></p>
<ol>
<li><p>排除 lettuce 采用 Jedis（不推荐）</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230313234108359.png" alt="image-20230313234108359" style="zoom:67%;" /> 
</li>
<li><p>重写连接工厂实例（不推荐）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//仅做参考，不写，不写，不写。</span>



<span class="token annotation punctuation">@Bean</span>

<span class="token keyword">public</span> <span class="token class-name">DefaultClientResources</span> <span class="token function">lettuceClientResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">return</span> <span class="token class-name">DefaultClientResources</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

 

<span class="token annotation punctuation">@Bean</span>

<span class="token keyword">public</span> <span class="token class-name">LettuceConnectionFactory</span> <span class="token function">lettuceConnectionFactory</span><span class="token punctuation">(</span><span class="token class-name">RedisProperties</span> redisProperties<span class="token punctuation">,</span> <span class="token class-name">ClientResources</span> clientResources<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

 

    <span class="token class-name">ClusterTopologyRefreshOptions</span> topologyRefreshOptions <span class="token operator">=</span> <span class="token class-name">ClusterTopologyRefreshOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token punctuation">.</span><span class="token function">enablePeriodicRefresh</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//按照周期刷新拓扑</span>

            <span class="token punctuation">.</span><span class="token function">enableAllAdaptiveRefreshTriggers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//根据事件刷新拓扑</span>

            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 

    <span class="token class-name">ClusterClientOptions</span> clusterClientOptions <span class="token operator">=</span> <span class="token class-name">ClusterClientOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment">//redis命令超时时间,超时后才会使用新的拓扑信息重新建立连接</span>

            <span class="token punctuation">.</span><span class="token function">timeoutOptions</span><span class="token punctuation">(</span><span class="token class-name">TimeoutOptions</span><span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token punctuation">.</span><span class="token function">topologyRefreshOptions</span><span class="token punctuation">(</span>topologyRefreshOptions<span class="token punctuation">)</span>

            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 

    <span class="token class-name">LettuceClientConfiguration</span> clientConfiguration <span class="token operator">=</span> <span class="token class-name">LettuceClientConfiguration</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token punctuation">.</span><span class="token function">clientResources</span><span class="token punctuation">(</span>clientResources<span class="token punctuation">)</span>

            <span class="token punctuation">.</span><span class="token function">clientOptions</span><span class="token punctuation">(</span>clusterClientOptions<span class="token punctuation">)</span>

            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 

    <span class="token class-name">RedisClusterConfiguration</span> clusterConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisClusterConfiguration</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    clusterConfig<span class="token punctuation">.</span><span class="token function">setMaxRedirects</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxRedirects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    clusterConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">RedisPassword</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 

    <span class="token class-name">LettuceConnectionFactory</span> lettuceConnectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LettuceConnectionFactory</span><span class="token punctuation">(</span>clusterConfig<span class="token punctuation">,</span> clientConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>

 

    <span class="token keyword">return</span> lettuceConnectionFactory<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>刷新节点集群拓扑动态感应（推荐）</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/lettuce-io/lettuce-core/wiki/Redis-Cluster#user-content-refreshing-the-cluster-topology-view">https://github.com/lettuce-io/lettuce-core/wiki/Redis-Cluster#user-content-refreshing-the-cluster-topology-view </a></li>
</ul>
</li>
</ol>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/typora-picture/image-20230313234154012.png" alt="image-20230313234154012" style="zoom: 67%;" />

<p><strong>第二次改写 yml</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">server.port=7777

spring.application.name=redis7_study

<span class="token comment"># ========================logging=====================</span>
logging.level.root=info
logging.level.com.atguigu.redis7=info
logging.pattern.console=%d<span class="token punctuation">&#123;</span>yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss.SSS<span class="token punctuation">&#125;</span> <span class="token punctuation">[</span>%thread<span class="token punctuation">]</span> %<span class="token punctuation">-</span>5level %logger<span class="token punctuation">-</span> %msg%n 

logging.file.name=D<span class="token punctuation">:</span>/mylogs2023/redis7_study.log
logging.pattern.file=%d<span class="token punctuation">&#123;</span>yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss.SSS<span class="token punctuation">&#125;</span> <span class="token punctuation">[</span>%thread<span class="token punctuation">]</span> %<span class="token punctuation">-</span>5level %logger<span class="token punctuation">-</span> %msg%n

<span class="token comment"># ========================swagger=====================</span>
spring.swagger2.enabled=true
<span class="token comment">#在springboot2.6.X结合swagger2.9.X会提示documentationPluginsBootstrapper空指针异常，</span>
<span class="token comment">#原因是在springboot2.6.X中将SpringMVC默认路径匹配策略从AntPathMatcher更改为PathPatternParser，</span>
<span class="token comment"># 导致出错，解决办法是matching-strategy切换回之前ant_path_matcher</span>
spring.mvc.pathmatch.matching<span class="token punctuation">-</span>strategy=ant_path_matcher


<span class="token comment"># ========================redis集群=====================</span>
spring.redis.password=111111
<span class="token comment"># 获取失败 最大重定向次数</span>
spring.redis.cluster.max<span class="token punctuation">-</span>redirects=3
spring.redis.lettuce.pool.max<span class="token punctuation">-</span>active=8
spring.redis.lettuce.pool.max<span class="token punctuation">-</span>wait=<span class="token punctuation">-</span>1ms
spring.redis.lettuce.pool.max<span class="token punctuation">-</span>idle=8
spring.redis.lettuce.pool.min<span class="token punctuation">-</span>idle=0
<span class="token comment">#支持集群拓扑动态感应刷新,自适应拓扑刷新是否使用所有可用的更新，默认false关闭</span>
spring.redis.lettuce.cluster.refresh.adaptive=true
<span class="token comment">#定时刷新</span>
spring.redis.lettuce.cluster.refresh.period=2000
spring.redis.cluster.nodes=192.168.111.175<span class="token punctuation">:</span><span class="token number">6381</span><span class="token punctuation">,</span>192.168.111.175<span class="token punctuation">:</span><span class="token number">6382</span><span class="token punctuation">,</span>192.168.111.172<span class="token punctuation">:</span><span class="token number">6383</span><span class="token punctuation">,</span>192.168.111.172<span class="token punctuation">:</span><span class="token number">6384</span><span class="token punctuation">,</span>192.168.111.174<span class="token punctuation">:</span><span class="token number">6385</span><span class="token punctuation">,</span>192.168.111.174<span class="token punctuation">:</span><span class="token number">6386</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





















































</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://byxl8112.github.io">byxl8112</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://byxl8112.github.io/posts/Redis.html">https://byxl8112.github.io/posts/Redis.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://byxl8112.github.io" target="_blank">byxl8112</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java%E7%AC%94%E8%AE%B0/">Java笔记</a></div><div class="post_share"><div class="social-share" data-image="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/12-Redis.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/money.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/money.jpg"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/Linux.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/13-Linux.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux</div></div></a></div><div class="next-post pull-right"><a href="/posts/MyBatisPlus.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/11-MyBatis-Plus.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MyBatis-Plus</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/Git.html" title="Git"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/xianqi-hexo/imgg/19.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-15</div><div class="title">Git</div></div></a></div><div><a href="/posts/Maven.html" title="Maven"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/xianqi-hexo/imgg/24.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-19</div><div class="title">Maven</div></div></a></div><div><a href="/posts/MySQL.html" title="MySql"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/xianqi-hexo/imgg/11.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-14</div><div class="title">MySql</div></div></a></div><div><a href="/posts/MyBatis.html" title="MyBatis"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/07-MyBatis.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-23</div><div class="title">MyBatis</div></div></a></div><div><a href="/posts/JavaWeb.html" title="JavaWeb"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/xianqi-hexo/imgg/30.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-22</div><div class="title">JavaWeb</div></div></a></div><div><a href="/posts/MyBatisPlus.html" title="MyBatis-Plus"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/11-MyBatis-Plus.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-01</div><div class="title">MyBatis-Plus</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/zzzw_8112/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20221130105527.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">byxl8112</div><div class="author-info__description">有志者，事竟成</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><a id="card-info-btn" href="https://byxl8112.github.io"><i class="fab fa-home"></i><span>个人主页</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/byxl8112" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=1662844460&amp;website=www.qtxml.cn" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">兴趣爱好才是最大的动力，何不与我共同来攀知识高峰！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E6%A6%82%E8%BF%B0%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">Redis概述和安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.1.</span> <span class="toc-text">步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">安装目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E5%90%AF%E5%8A%A8%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">1.2.3.</span> <span class="toc-text">前台启动（不推荐）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E5%90%AF%E5%8A%A8%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">1.2.4.</span> <span class="toc-text">后台启动（推荐）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.</span> <span class="toc-text">Redis介绍</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">常用五大数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%AE%EF%BC%88key%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">键（key）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%88String%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">字符串（String）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.1.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.2.2.</span> <span class="toc-text">数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%97%E8%A1%A8%EF%BC%88List%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">列表（List）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-1"><span class="toc-number">2.3.1.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E5%90%88%EF%BC%88Set%EF%BC%89"><span class="toc-number">2.4.</span> <span class="toc-text">集合（Set）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-2"><span class="toc-number">2.4.1.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-2"><span class="toc-number">2.4.2.</span> <span class="toc-text">数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%EF%BC%88Hash%EF%BC%89"><span class="toc-number">2.5.</span> <span class="toc-text">哈希（Hash）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-3"><span class="toc-number">2.5.1.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-3"><span class="toc-number">2.5.2.</span> <span class="toc-text">数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88-Zset-shorted-set"><span class="toc-number">2.6.</span> <span class="toc-text">有序集合 Zset(shorted set)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-4"><span class="toc-number">2.6.1.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-4"><span class="toc-number">2.6.2.</span> <span class="toc-text">数据结构</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%B0%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">新数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%8D%E5%9B%BE%EF%BC%88Bitmaps%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">位图（Bitmaps）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-5"><span class="toc-number">3.1.1.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bitmaps-%E4%B8%8E-set-%E5%AF%B9%E6%AF%94"><span class="toc-number">3.1.2.</span> <span class="toc-text">Bitmaps 与 set 对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%95%B0%E7%BB%9F%E8%AE%A1%EF%BC%88HyperLogLog%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">基数统计（HyperLogLog）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-6"><span class="toc-number">3.2.1.</span> <span class="toc-text">常用命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E7%90%86%E7%A9%BA%E9%97%B4%EF%BC%88Geospatial%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">地理空间（Geospatial）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-7"><span class="toc-number">3.3.1.</span> <span class="toc-text">常用命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%EF%BC%88Stream%EF%BC%89"><span class="toc-number">3.4.</span> <span class="toc-text">流（Stream）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84%E5%92%8C%E5%8E%9F%E7%90%86"><span class="toc-number">3.4.1.</span> <span class="toc-text">底层结构和原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-8"><span class="toc-number">3.4.2.</span> <span class="toc-text">常用命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%8D%E5%9F%9F%EF%BC%88bitfield%EF%BC%89"><span class="toc-number">3.5.</span> <span class="toc-text">位域（bitfield）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%88RDB-AOF%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">Redis持久化（RDB + AOF）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RDB"><span class="toc-number">4.1.</span> <span class="toc-text">RDB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Fork"><span class="toc-number">4.1.1.</span> <span class="toc-text">Fork</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%92%8C%E4%BF%AE%E5%A4%8D-dump-rdb-%E6%96%87%E4%BB%B6"><span class="toc-number">4.1.3.</span> <span class="toc-text">检查和修复 dump.rdb 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.1.4.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91RDB%E5%BF%AB%E7%85%A7%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">4.1.4.1.</span> <span class="toc-text">触发RDB快照的情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E5%BF%AB%E7%85%A7"><span class="toc-number">4.1.4.2.</span> <span class="toc-text">禁用快照</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RDB%E4%BC%98%E5%8C%96%E5%8F%82%E6%95%B0"><span class="toc-number">4.1.5.</span> <span class="toc-text">RDB优化参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOF"><span class="toc-number">4.2.</span> <span class="toc-text">AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AOF%E6%8C%81%E4%B9%85%E5%8C%96%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.1.</span> <span class="toc-text">AOF持久化工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E5%86%99%E5%9B%9E%E7%AD%96%E7%95%A5"><span class="toc-number">4.2.2.</span> <span class="toc-text">三种写回策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BF%9D%E5%AD%98%E8%AF%B4%E6%98%8E"><span class="toc-number">4.2.3.</span> <span class="toc-text">文件保存说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Multi-part-AOF"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">Multi-part AOF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF-appendonly-yes"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">开启 appendonly yes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#aof%E6%96%87%E4%BB%B6-%E4%BF%9D%E5%AD%98%E8%B7%AF%E5%BE%84"><span class="toc-number">4.2.3.3.</span> <span class="toc-text">aof文件-保存路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#aof%E6%96%87%E4%BB%B6-%E4%BF%9D%E5%AD%98%E5%90%8D%E7%A7%B0"><span class="toc-number">4.2.3.4.</span> <span class="toc-text">aof文件-保存名称</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">4.2.4.</span> <span class="toc-text">配置文件说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E6%81%A2%E5%A4%8D"><span class="toc-number">4.2.4.1.</span> <span class="toc-text">正常恢复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%81%A2%E5%A4%8D"><span class="toc-number">4.2.4.2.</span> <span class="toc-text">异常恢复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8A%BF"><span class="toc-number">4.2.4.3.</span> <span class="toc-text">优势</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A3%E5%8A%BF"><span class="toc-number">4.2.4.4.</span> <span class="toc-text">劣势</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOF%E9%87%8D%E5%86%99%E6%9C%BA%E5%88%B6"><span class="toc-number">4.2.5.</span> <span class="toc-text">AOF重写机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">4.2.5.1.</span> <span class="toc-text">案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">4.2.5.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF-%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">4.2.5.3.</span> <span class="toc-text">AOF 优化配置详解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOF%E6%80%BB%E7%BB%93"><span class="toc-number">4.2.6.</span> <span class="toc-text">AOF总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RDB-AOF%E6%B7%B7%E5%90%88%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">4.3.</span> <span class="toc-text">RDB+AOF混合持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%97%B6%E5%BC%80%E5%90%AF%E4%B8%A4%E7%A7%8D%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%B9%E5%BC%8F"><span class="toc-number">4.3.1.</span> <span class="toc-text">同时开启两种持久化方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%AF%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.4.</span> <span class="toc-text">纯缓存模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.1.</span> <span class="toc-text">Redis事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-9"><span class="toc-number">5.1.1.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%83%85%E5%86%B5"><span class="toc-number">5.1.2.</span> <span class="toc-text">执行情况</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E6%89%A7%E8%A1%8C"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">正常执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BE%E5%BC%83%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">放弃事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E4%BD%93%E8%BF%9E%E5%9D%90"><span class="toc-number">5.1.2.3.</span> <span class="toc-text">全体连坐</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%A4%E5%A4%B4%E5%80%BA%E4%B8%BB"><span class="toc-number">5.1.2.4.</span> <span class="toc-text">冤头债主</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#watch%E7%9B%91%E6%8E%A7"><span class="toc-number">5.1.2.5.</span> <span class="toc-text">watch监控</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%A1%E9%81%93"><span class="toc-number">6.</span> <span class="toc-text">管道</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">6.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="toc-number">6.2.</span> <span class="toc-text">案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">6.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E5%8F%91%E5%B8%83-x2F-%E8%AE%A2%E9%98%85%EF%BC%88pub-x2F-sub%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">Redis发布&#x2F;订阅（pub&#x2F;sub）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-2"><span class="toc-number">7.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-10"><span class="toc-number">7.2.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pub-x2F-Sub%E7%BC%BA%E7%82%B9"><span class="toc-number">7.3.</span> <span class="toc-text">Pub&#x2F;Sub缺点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E5%A4%8D%E5%88%B6%EF%BC%88replica%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">Redis复制（replica）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-3"><span class="toc-number">8.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-11"><span class="toc-number">8.2.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-2"><span class="toc-number">8.3.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%BB%86%E8%8A%82"><span class="toc-number">8.3.1.</span> <span class="toc-text">操作细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%86"><span class="toc-number">8.3.2.</span> <span class="toc-text">一主二仆</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%881%EF%BC%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%9B%BA%E5%AE%9A%E5%86%99%E6%AD%BB"><span class="toc-number">8.3.2.1.</span> <span class="toc-text">方案1：配置文件固定写死</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%882%EF%BC%9A%E5%91%BD%E4%BB%A4%E6%93%8D%E4%BD%9C%E6%89%8B%E5%8A%A8%E6%8C%87%E5%AE%9A"><span class="toc-number">8.3.2.2.</span> <span class="toc-text">方案2：命令操作手动指定</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%96%AA%E7%81%AB%E7%9B%B8%E4%BC%A0"><span class="toc-number">8.3.3.</span> <span class="toc-text">薪火相传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%AE%A2%E4%B8%BA%E4%B8%BB"><span class="toc-number">8.3.4.</span> <span class="toc-text">反客为主</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86%E5%92%8C%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">8.4.</span> <span class="toc-text">复制原理和工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">8.5.</span> <span class="toc-text">复制的缺点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E5%93%A8%E5%85%B5%EF%BC%88sentinel%EF%BC%89"><span class="toc-number">9.</span> <span class="toc-text">Redis哨兵（sentinel）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-4"><span class="toc-number">9.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1"><span class="toc-number">9.2.</span> <span class="toc-text">步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-1"><span class="toc-number">9.2.1.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E9%83%A8%E5%88%86"><span class="toc-number">9.2.2.</span> <span class="toc-text">哨兵部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E5%8E%9F%E7%90%86"><span class="toc-number">9.3.</span> <span class="toc-text">哨兵原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B-%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2"><span class="toc-number">9.3.1.</span> <span class="toc-text">运行流程 故障切换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">9.4.</span> <span class="toc-text">哨兵使用建议</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E9%9B%86%E7%BE%A4%EF%BC%88cluster%EF%BC%89"><span class="toc-number">10.</span> <span class="toc-text">Redis集群（cluster）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-5"><span class="toc-number">10.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%AE%97%E6%B3%95-%E5%88%86%E7%89%87-%E6%A7%BD%E4%BD%8Dslot"><span class="toc-number">10.2.</span> <span class="toc-text">集群算法-分片-槽位slot</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A7%BD%E4%BD%8Dslot%E4%B8%8E%E5%88%86%E7%89%87"><span class="toc-number">10.2.1.</span> <span class="toc-text">槽位slot与分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slot%E6%A7%BD%E4%BD%8D%E6%98%A0%E5%B0%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">10.2.2.</span> <span class="toc-text">slot槽位映射解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E5%8F%96%E4%BD%99%E5%88%86%E5%8C%BA"><span class="toc-number">10.2.2.1.</span> <span class="toc-text">哈希取余分区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95"><span class="toc-number">10.2.2.2.</span> <span class="toc-text">一致性哈希算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E6%A7%BD%E5%88%86%E5%8C%BA%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-number">10.2.2.3.</span> <span class="toc-text">哈希槽分区（重要）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E9%9B%86%E7%BE%A4%E6%9C%80%E5%A4%A7%E6%A7%BD%E6%95%B0%E6%98%AF16384%E4%B8%AA"><span class="toc-number">10.2.3.</span> <span class="toc-text">Redis集群最大槽数是16384个</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0"><span class="toc-number">10.2.3.1.</span> <span class="toc-text">原因</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-3"><span class="toc-number">10.3.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E4%B8%BB%E4%B8%89%E4%BB%8Eredis%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">10.3.1.</span> <span class="toc-text">三主三从redis集群配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%AE%B9%E9%94%99%E5%88%87%E6%8D%A2%E8%BF%81%E7%A7%BB%E6%A1%88%E4%BE%8B"><span class="toc-number">10.3.2.</span> <span class="toc-text">主从容错切换迁移案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%89%A9%E5%AE%B9%E6%A1%88%E4%BE%8B"><span class="toc-number">10.3.3.</span> <span class="toc-text">集群扩容案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%BC%A9%E5%AE%B9%E6%A1%88%E4%BE%8B"><span class="toc-number">10.3.4.</span> <span class="toc-text">集群缩容案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4%E5%92%8CCRC16%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-number">10.4.</span> <span class="toc-text">集群常用操作命令和CRC16算法分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Springboot%E6%95%B4%E5%90%88Redis"><span class="toc-number">11.</span> <span class="toc-text">Springboot整合Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90Jedis"><span class="toc-number">11.1.</span> <span class="toc-text">集成Jedis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90Lettuce"><span class="toc-number">11.2.</span> <span class="toc-text">集成Lettuce</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90RedisTemplate%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-number">11.3.</span> <span class="toc-text">集成RedisTemplate（重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%8D%95%E6%9C%BA"><span class="toc-number">11.3.1.</span> <span class="toc-text">连接单机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E9%9B%86%E7%BE%A4"><span class="toc-number">11.3.2.</span> <span class="toc-text">连接集群</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/webpack.html" title="Webpack"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/20-webpack.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Webpack"/></a><div class="content"><a class="title" href="/posts/webpack.html" title="Webpack">Webpack</a><time datetime="2023-11-16T10:00:00.000Z" title="发表于 2023-11-16 18:00:00">2023-11-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/web-APIs.html" title="web-APIs"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/19-web-APIs.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="web-APIs"/></a><div class="content"><a class="title" href="/posts/web-APIs.html" title="web-APIs">web-APIs</a><time datetime="2023-11-14T16:06:29.000Z" title="发表于 2023-11-15 00:06:29">2023-11-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/JS.html" title="JavaScript基础"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/18-js.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JavaScript基础"/></a><div class="content"><a class="title" href="/posts/JS.html" title="JavaScript基础">JavaScript基础</a><time datetime="2023-11-13T07:01:00.000Z" title="发表于 2023-11-13 15:01:00">2023-11-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/14-2-1.html" title="CSS图标库配置(阿里和icomoon)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/01-question.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CSS图标库配置(阿里和icomoon)"/></a><div class="content"><a class="title" href="/posts/14-2-1.html" title="CSS图标库配置(阿里和icomoon)">CSS图标库配置(阿里和icomoon)</a><time datetime="2023-10-18T03:42:00.000Z" title="发表于 2023-10-18 11:42:00">2023-10-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/MongoDB.html" title="MongoDB"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://typora8112.oss-cn-beijing.aliyuncs.com/byxl8112-pictures/17-MongoDB.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MongoDB"/></a><div class="content"><a class="title" href="/posts/MongoDB.html" title="MongoDB">MongoDB</a><time datetime="2023-10-09T08:11:00.000Z" title="发表于 2023-10-09 16:11:00">2023-10-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> byxl8112</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><<head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://vercel-comments-fu6q.vercel.app',
      region: 'us-east-1',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://vercel-comments-fu6q.vercel.app',
      region: 'us-east-1',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo@1/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer data-pjax type="text/javascript" src="https://npm.elemecdn.com/xianqi-hexo/js/animate.js"></script><div class="aplayer no-destroy" data-id="2358838077" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="auto" data-autoplay="false" muted></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script src="//code.tidio.co/null.js" async="async"></script><script>function onTidioChatApiReady() {
  window.tidioChatApi.hide();
  window.tidioChatApi.on("close", function() {
    window.tidioChatApi.hide();
  });
}
if (window.tidioChatApi) {
  window.tidioChatApi.on("ready", onTidioChatApiReady);
} else {
  document.addEventListener("tidioChat-ready", onTidioChatApiReady);
}

var chatBtnFn = () => {
  document.getElementById("chat_btn").addEventListener("click", function(){
    window.tidioChatApi.show();
    window.tidioChatApi.open();
  });
}
chatBtnFn()
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#posts-chart","#tags-chart","#categories-chart",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":160,"height":260},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>